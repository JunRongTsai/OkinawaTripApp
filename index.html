<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦ªæ„æ—…ç¨‹ | æ²–ç¹©é›²ç«¯å”ä½œåŠ©æ‰‹</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy,
            setLogLevel
        };
        
        window.isAuthReady = false; 
        window.authError = null;

        const APP_ID_FOR_NETLIFY = 'okinawa-group-trip-2026'; 
        const FIREBASE_CONFIG_FOR_NETLIFY = {
             apiKey: "AIzaSyDc7dkeG9RJcmyuNv2ZYDZEtkTUwNWAYek",
             authDomain: "travelapp-b382d.firebaseapp.com",
             projectId: "travelapp-b382d",
             storageBucket: "travelapp-b382d.firebasestorage.app",
             messagingSenderId: "579137022414",
             appId: "1:579137022414:web:890bcdc6ffa6e25f5da39f",
             measurementId: "G-T0YDHHG7DN"
        };
        
        const appId = APP_ID_FOR_NETLIFY; 
        const firebaseConfig = FIREBASE_CONFIG_FOR_NETLIFY;
        
        let firebaseReady = false;
        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            firebaseReady = true;
        }

        async function initFirebaseAndAuth() {
            if (!firebaseReady) return;
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.isAuthReady = true; 
                        window.userId = user.uid;
                        if (localStorage.getItem('zenTravelApp_currentTab') === 'plan') switchTab('plan'); 
                    }
                });
            } catch (error) {
                window.authError = error;
                window.isAuthReady = true; 
            }
        }
        window.initFirebaseAndAuth = initFirebaseAndAuth;
    </script>

    <style>
        :root { --color-primary: #C89088; --color-secondary: #8D9B8B; --color-background: #F7F3E8; --color-card: #FFFFFF; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--color-background); padding-bottom: 72px; }
        .primary-bg { background-color: var(--color-primary); }
        .primary-text { color: var(--color-primary); }
        .secondary-bg { background-color: var(--color-secondary); }
        .bg-card { background-color: var(--color-card); }
        .timeline-item { position: relative; padding-left: 20px; border-left: 2px solid #D1D5DB; }
        .timeline-item::before { content: ''; position: absolute; left: -8px; top: 0; width: 14px; height: 14px; border-radius: 50%; background-color: var(--color-secondary); border: 2px solid var(--color-background); }
        .timeline-highlight::before { background-color: var(--color-primary) !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 3px; }
    </style>
</head>
<body>

    <header class="fixed top-0 left-0 right-0 bg-card shadow p-4 z-30">
        <h1 id="app-title" class="text-xl font-bold primary-text text-center">æ—…ç¨‹è¦åŠƒ (PLAN)</h1>
    </header>

    <main id="app-content" class="pt-[64px] pb-4 px-4"></main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 h-16 primary-bg shadow-2xl z-30 flex justify-around items-center">
        <button onclick="switchTab('plan')" class="nav-icon text-white flex flex-col items-center p-2">
            <i class="fa-solid fa-calendar-alt text-xl"></i><span class="text-[10px]">è¡Œç¨‹è¡¨</span>
        </button>
        <button onclick="switchTab('guide')" class="nav-icon text-white/60 flex flex-col items-center p-2">
            <i class="fa-solid fa-compass text-xl"></i><span class="text-[10px]">å°è¦½</span>
        </button>
        <button onclick="switchTab('wallet')" class="nav-icon text-white/60 flex flex-col items-center p-2">
            <i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px]">è¨˜å¸³</span>
        </button>
        <button onclick="switchTab('lists')" class="nav-icon text-white/60 flex flex-col items-center p-2">
            <i class="fa-solid fa-list-check text-xl"></i><span class="text-[10px]">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('info')" class="nav-icon text-white/60 flex flex-col items-center p-2">
            <i class="fa-solid fa-circle-info text-xl"></i><span class="text-[10px]">è³‡è¨Š</span>
        </button>
    </nav>

    <!-- Map Modal -->
    <div id="map-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-card w-full max-w-xs rounded-xl p-6 shadow-2xl">
            <h3 id="map-modal-title" class="font-bold primary-text mb-4 border-b pb-2">åœ°é»åœ°åœ–</h3>
            <p id="map-modal-desc" class="text-sm text-gray-600 mb-6">å³å°‡é–‹å•Ÿåœ°åœ–å°èˆª...</p>
            <div class="flex justify-end space-x-2">
                <button onclick="closeMapModal()" class="text-gray-400 px-3">å–æ¶ˆ</button>
                <a id="map-external-link" target="_blank" class="primary-bg text-white px-4 py-2 rounded-lg font-bold">å‰å¾€</a>
            </div>
        </div>
    </div>

<script>
    // ====================================================================
    // 1. Data & Global Config (åŒ…å«è©³ç´°èˆªç­è³‡è¨Š)
    // ====================================================================
    const TWD_RATE_KEY = 'zenTravelApp_TWD_RATE_V2';
    const LS_KEYS = { WALLET: 'zenTravelApp_wallet', CHECKLIST: 'zenTravelApp_checklist', MEMOS: 'zenTravelApp_memos', CURRENT_TAB: 'zenTravelApp_currentTab' };

    let cloudItineraryData = [];
    let unsubscribeItinerary = null;

    const STATIC_TRAVEL_DATA = {
        flight: { 
            outbound: {
                no: "IT288",
                route: "é«˜é›„ (KHH) â†’ æ²–ç¹© (OKA)",
                time: "09:45 â†’ 12:30",
                duration: "1å°æ™‚45åˆ†"
            },
            return: {
                no: "IT289",
                route: "æ²–ç¹© (OKA) â†’ é«˜é›„ (KHH)",
                time: "13:30 â†’ 14:25",
                duration: "1å°æ™‚55åˆ†"
            }
        },
        hotel: "é‚£éœ¸ç¸£å»³å‰é˜¿çˆ¾è’™ç‰¹ (Almont Hotel)",
        hotelAddr: "æ²–ç¹©ç¸£é‚£éœ¸å¸‚ä¹…èŒ‚åœ° 1-3-5",
        prepList: ["è­·ç…§ã€ç°½è­‰", "æ—¥å¹£ç¾é‡‘ã€ä¿¡ç”¨å¡", "ç¶²å¡/eSIM", "å……é›»å™¨", "é›¨å…·", "å€‹äººè—¥å“", "æ›æ´—è¡£ç‰©", "æ—…éŠä¿éšªå–®"]
    };

    const DEFAULT_ITINERARY = [
        { id: 'D1', day: 'D1 (æŠµé”)', date: '03/07 (å…­)', order: 1, events: [{ time: '12:30', name: 'æŠµé” OKA æ©Ÿå ´', type: 'info' }, { time: '15:00', name: 'é£¯åº— Check-in', type: 'info', location: 'Almont Hotel' }] },
        { id: 'D5', day: 'D5 (è¿”ç¨‹)', date: '03/11 (ä¸‰)', order: 5, events: [
            { time: '09:00', name: 'é£¯åº—é€€æˆ¿ / å¯„æ”¾è¡Œæ', type: 'info' },
            { time: '10:30', name: 'å‡ºç™¼å‰å¾€æ©Ÿå ´', type: 'highlight' },
            { time: '11:30', name: 'æŠµé”æ©Ÿå ´å ±åˆ° (IT289)', type: 'info' },
            { time: '13:30', name: 'IT289 èµ·é£›', type: 'info' }
        ]}
    ];

    function initializeStorage() {
        if (!localStorage.getItem(LS_KEYS.CHECKLIST)) {
            saveData(LS_KEYS.CHECKLIST, STATIC_TRAVEL_DATA.prepList.map(item => ({ id: crypto.randomUUID(), text: item, checked: false })));
        }
        if (!localStorage.getItem(LS_KEYS.WALLET)) saveData(LS_KEYS.WALLET, []);
        if (!localStorage.getItem(LS_KEYS.MEMOS)) localStorage.setItem(LS_KEYS.MEMOS, '');
        if (!localStorage.getItem(TWD_RATE_KEY)) localStorage.setItem(TWD_RATE_KEY, "0.215");
    }

    function loadData(k, d) { try { return JSON.parse(localStorage.getItem(k)) || d; } catch(e) { return d; } }
    function saveData(k, d) { localStorage.setItem(k, JSON.stringify(d)); }

    // ====================================================================
    // 2. Real-time Exchange Rate (API Fetching)
    // ====================================================================
    async function updateRealtimeRate() {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
            const data = await res.json();
            const rate = data.rates.TWD;
            localStorage.setItem(TWD_RATE_KEY, rate);
            return rate;
        } catch (e) {
            console.error("Fetch rate failed", e);
            return parseFloat(localStorage.getItem(TWD_RATE_KEY)) || 0.215;
        }
    }

    // ====================================================================
    // 3. Tab Rendering Logic
    // ====================================================================
    const TABS = {
        plan: { title: 'æ—…ç¨‹è¦åŠƒ (PLAN)', renderer: renderPlan },
        guide: { title: 'æ·±åº¦å°è¦½ (GUIDE)', renderer: renderGuide },
        wallet: { title: 'è¨˜å¸³èˆ‡åŒ¯ç‡ (WALLET)', renderer: renderWallet },
        lists: { title: 'æ¸…å–®èˆ‡å‚™å¿˜ (LISTS)', renderer: renderLists },
        info: { title: 'å¯¦ç”¨è³‡è¨Š (INFO)', renderer: renderInfo }
    };

    function switchTab(t) {
        const area = document.getElementById('app-content');
        const title = document.getElementById('app-title');
        const navs = document.querySelectorAll('.nav-icon');
        if (!TABS[t]) return;
        if (unsubscribeItinerary) { unsubscribeItinerary(); unsubscribeItinerary = null; }
        
        navs.forEach(n => {
            const isActive = n.getAttribute('onclick').includes(`'${t}'`);
            n.classList.toggle('text-white', isActive);
            n.classList.toggle('text-white/60', !isActive);
        });

        title.textContent = TABS[t].title;
        area.innerHTML = '';
        TABS[t].renderer(area);
        localStorage.setItem(LS_KEYS.CURRENT_TAB, t);
    }

    // ====================================================================
    // 4. PLAN (Firestore CRUD)
    // ====================================================================
    function getColRef() { return firebaseModules.collection(db, 'artifacts', appId, 'public', 'data', 'itineraries'); }

    function renderPlan(container) {
        if (!window.isAuthReady) { container.innerHTML = '<div class="py-20 text-center"><i class="fas fa-spinner fa-spin text-3xl"></i></div>'; return; }
        
        const f = STATIC_TRAVEL_DATA.flight;
        container.innerHTML = `
            <div class="mb-4 space-y-3">
                <!-- è©³ç´°èˆªç­è³‡è¨Šå¡ç‰‡ -->
                <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-blue-400 text-xs">
                    <div class="flex justify-between items-end border-b pb-2 mb-2">
                        <h4 class="font-bold primary-text text-sm"><i class="fa-solid fa-plane mr-2"></i>èˆªç­è©³ç´°è³‡è¨Š</h4>
                        <span class="text-gray-300">Tigerair Taiwan</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <p class="font-bold text-gray-700">${f.outbound.no} | ${f.outbound.route}</p>
                            <p class="text-gray-500">${f.outbound.time} (${f.outbound.duration})</p>
                        </div>
                        <div>
                            <p class="font-bold text-gray-700">${f.return.no} | ${f.return.route}</p>
                            <p class="text-gray-500">${f.return.time} (${f.return.duration})</p>
                        </div>
                    </div>
                </div>

                <!-- ä½å®¿è³‡è¨Šå¡ç‰‡ (åŒ…å«åœ°åœ–é€£çµ) -->
                <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-amber-400 text-xs flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-700 text-sm">ğŸ¨ ${STATIC_TRAVEL_DATA.hotel}</p>
                        <p class="text-gray-400 mt-0.5">${STATIC_TRAVEL_DATA.hotelAddr}</p>
                    </div>
                    <button onclick="showMapModal('${STATIC_TRAVEL_DATA.hotelAddr}', '${STATIC_TRAVEL_DATA.hotel}')" class="primary-bg text-white px-3 py-2 rounded-lg font-bold shadow-sm">
                        <i class="fa-solid fa-map-location-dot"></i>
                    </button>
                </div>

                <button onclick="showAddDayModal()" class="w-full mt-2 primary-bg text-white py-2 rounded-full font-bold shadow-md">+ æ–°å¢è¡Œç¨‹æ—¥</button>
            </div>
            <div id="p-list" class="space-y-6"></div>
        `;
        const q = firebaseModules.query(getColRef(), firebaseModules.orderBy('order', 'asc'));
        unsubscribeItinerary = firebaseModules.onSnapshot(q, (snap) => {
            cloudItineraryData = snap.docs.map(d => ({ ...d.data(), docId: d.id }));
            if (cloudItineraryData.length === 0) { DEFAULT_ITINERARY.forEach(d => firebaseModules.setDoc(firebaseModules.doc(getColRef(), d.id), d)); return; }
            document.getElementById('p-list').innerHTML = cloudItineraryData.map(day => `
                <div class="p-4 bg-card rounded-xl shadow relative">
                    <div class="absolute top-2 right-2 flex space-x-2 text-gray-300">
                        <button onclick="showEditDayModal('${day.docId}','${day.day}','${day.date}',${day.order})"><i class="fa-solid fa-edit"></i></button>
                        <button onclick="confirmDelDay('${day.docId}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <h3 class="font-bold secondary-text border-b pb-2 mb-4">${day.day} - ${day.date}</h3>
                    <div class="space-y-4">
                        ${(day.events || []).map((ev, i) => `
                            <div class="timeline-item group">
                                <div class="ml-4 flex justify-between items-start">
                                    <div>
                                        <p class="text-[10px] text-gray-400 font-mono">${ev.time}</p>
                                        <p class="text-sm font-semibold text-gray-800">${ev.name}</p>
                                        ${ev.location?`<button onclick="showMapModal('${ev.location}','${ev.name}')" class="text-[10px] mt-1 primary-bg text-white px-2 py-0.5 rounded-full">åœ°åœ–</button>`:''}
                                    </div>
                                    <div class="opacity-0 group-hover:opacity-100 flex transition space-x-2">
                                        <button onclick="showEditEventModal('${day.docId}', ${i})" class="text-gray-400 hover:text-blue-400"><i class="fa-solid fa-pencil text-xs"></i></button>
                                        <button onclick="confirmDelEv('${day.docId}', ${i}, '${ev.name}')" class="text-red-200 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        <button onclick="showAddEvModal('${day.docId}')" class="w-full py-2 border-2 border-dashed border-gray-100 rounded-lg text-xs text-gray-300">+ æ–°å¢æ´»å‹•</button>
                    </div>
                </div>
            `).join('');
        });
    }

    // ====================================================================
    // 5. GUIDE (æ·±åº¦å°è¦½)
    // ====================================================================
    function getLocationEmoji(n) {
        const m = { 'åœ‹éš›é€š': 'ğŸ›ï¸', 'æ³¢ä¸Šå®®': 'â›©ï¸', 'é¦–é‡ŒåŸ': 'ğŸ¯', 'ç€¨é•·å³¶': 'ğŸ–ï¸', 'å¸‚å ´': 'ğŸŸ', 'æ°´æ—é¤¨': 'ğŸ ', 'ç¦å·åœ’': 'ğŸŒ³', 'DFS': 'ğŸ’', 'Outlet': 'ğŸ‘œ', 'å£ºå±‹': 'ğŸº' };
        for (let key in m) if (n.includes(key)) return m[key]; return 'ğŸ“';
    }

    function getFoodEmoji(n) {
        const m = { 'éºµ': 'ğŸœ', 'è±¬': 'ğŸ·', 'ç‰›': 'ğŸ¥©', 'å†°': 'ğŸ¦', 'å¡”å¯': 'ğŸŒ®', 'æµ·è‘¡è„': 'ğŸ‡', 'ç´…èŠ‹': 'ğŸ ', 'è‹¦ç“œ': 'ğŸ³', 'è±†è…': 'ğŸ®', 'æµ·é®®': 'ğŸ¦' };
        for (let key in m) if (n.includes(key)) return m[key]; return 'ğŸ½ï¸';
    }

    function renderGuide(container) {
        const spots = [
            { n: "åœ‹éš›é€š", d: "é‚£éœ¸æœ€ç†±é¬§è¡—é“ï¼Œè³¼ç‰©å¤©å ‚ã€‚", l: "åœ‹éš›é€š", h: "10:00-22:00" },
            { n: "æ³¢ä¸Šå®®", d: "æ‡¸å´–ä¸Šçš„ç¥ç¤¾ï¼Œæœ‰æµ·é‚Šæ²™ç˜ã€‚", l: "æ³¢ä¸Šå®®", h: "09:00-17:00" },
            { n: "é¦–é‡ŒåŸ", d: "ç‰çƒç‹åœ‹è±¡å¾µï¼Œä¸–ç•Œéºç”¢éºå€ã€‚", l: "é¦–é‡ŒåŸ", h: "08:30-18:00" },
            { n: "ç€¨é•·å³¶ Umikaji", d: "ç™½è‰²åœ°ä¸­æµ·é¢¨ï¼Œçœ‹é£›æ©Ÿèµ·é™ã€‚", l: "ç€¨é•·å³¶", h: "10:00-21:00" },
            { n: "ç‰§å¿—å…¬è¨­å¸‚å ´", d: "æ²–ç¹©å»šæˆ¿ï¼Œæ–°é®®æµ·ç”¢ä»£å®¢æ–™ç†ã€‚", l: "ç¬¬ä¸€ç‰§å¿—å…¬è¨­å¸‚å ´", h: "08:00-21:00" },
            { n: "DMM Kariyushi æ°´æ—é¤¨", d: "ç¾ä»£åŒ–å½±åƒæ°´æ—é¤¨ï¼Œäº¤é€šä¾¿åˆ©ã€‚", l: "DMMæ°´æ—é¤¨", h: "10:00-21:00" },
            { n: "ç¦å·åœ’", d: "ç²¾ç·»ä¸­å¼åœ’æ—ï¼Œå¸‚å€ç¶ æ´²ã€‚", l: "ç¦å·åœ’", h: "09:00-21:00" },
            { n: "T Galleria (DFS)", d: "ç²¾å“å…ç¨…ç™¾è²¨ï¼Œä½æ–¼æ–°éƒ½å¿ƒã€‚", l: "T Galleria", h: "10:00-20:00" },
            { n: "Ashibinaa Outlet", d: "æš¢è²¨ä¸­å¿ƒï¼Œé è¿‘æ©Ÿå ´é©åˆæœ€å¾Œæ¡è²·ã€‚", l: "Ashibinaa", h: "10:00-20:00" },
            { n: "å£ºå±‹é€š", d: "å‚³çµ±é™¶è—è¡—é“ï¼Œæ–‡é’æ•£ç­–ã€‚", l: "å£ºå±‹é€š", h: "10:00-18:00" }
        ];
        const foods = [
            { n: "æ²–ç¹©éºµ (Soba)", b: "å°éº¥è£½éºµï¼Œé…ä¸Šè»Ÿå«©è±¬è‚‰ã€‚" }, { n: "é˜¿å¤è±¬ (Agu)", b: "æ²¹è„‚ç”˜ç”œçš„æ²–ç¹©åœ‹å¯¶è±¬ã€‚" },
            { n: "çŸ³å£ç‰› (Beef)", b: "å…¥å£å³åŒ–çš„é ‚ç´šå’Œç‰›ã€‚" }, { n: "Blue Seal å†°æ·‡æ·‹", b: "æ²–ç¹©ä»£è¡¨æ€§ç¾å¼å†°æ·‡æ·‹ã€‚" },
            { n: "å¡”å¯é£¯ (Taco Rice)", b: "ç¾å¢¨é¢¨å‘³èˆ‡ç±³é£¯çš„å®Œç¾çµåˆã€‚" }, { n: "æµ·è‘¡è„", b: "å¤§æµ·çš„é­šå­é†¬ï¼Œå£æ„Ÿç¨ç‰¹ã€‚" },
            { n: "ç´…èŠ‹å¡”", b: "ä¼´æ‰‹ç¦®é¦–é¸ï¼Œç´«è‰²ç´…èŠ‹è£½ä½œã€‚" }, { n: "è‹¦ç“œç‚’è›‹", b: "ç¶“å…¸å®¶å¸¸èœï¼Œå¥åº·åˆç¾å‘³ã€‚" },
            { n: "èŠ±ç”Ÿè±†è…", b: "æ¿ƒéƒèŠ±ç”Ÿé¦™æ°£ï¼Œç¶¿å¯†ç´®å¯¦ã€‚" }, { n: "ä»£å®¢æ–™ç†æµ·é®®", b: "å¸‚å ´æŒ‘é¸æ¼ç²ç«‹å³å“åšã€‚" }
        ];

        container.innerHTML = `
            <div class="space-y-8 pb-4">
                <div class="bg-card p-6 rounded-xl shadow border-l-4 border-primary">
                    <h2 class="font-bold primary-text mb-4 flex items-center"><i class="fa-solid fa-map-location-dot mr-2"></i>æ²–ç¹© TOP 10 æ™¯é»</h2>
                    <div class="space-y-6">
                        ${spots.map((s, i) => `
                            <div class="flex items-start border-b border-gray-50 pb-4 last:border-0">
                                <div class="w-14 h-14 bg-secondary/10 rounded-xl flex-shrink-0 flex items-center justify-center text-2xl mr-4">${getLocationEmoji(s.n)}</div>
                                <div class="flex-grow">
                                    <h4 class="font-bold text-sm text-gray-800">${i+1}. ${s.n}</h4>
                                    <p class="text-[11px] text-gray-500 mt-1">${s.d}</p>
                                    <div class="flex space-x-2 mt-2">
                                        <button onclick="showMapModal('${s.l}','${s.n}')" class="text-[10px] primary-bg text-white px-2 py-0.5 rounded-full">åœ°åœ–å°èˆª</button>
                                        <span class="text-[10px] text-gray-400">ğŸ•’ ${s.h}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="bg-card p-6 rounded-xl shadow border-l-4 border-secondary">
                    <h2 class="font-bold secondary-text mb-4 flex items-center"><i class="fa-solid fa-utensils mr-2"></i>æ²–ç¹© TOP 10 ç¾é£Ÿ</h2>
                    <div class="grid grid-cols-1 gap-4">
                        ${foods.map((f, i) => `
                            <div class="flex items-center p-3 bg-secondary/5 rounded-lg border border-secondary/10">
                                <div class="text-xl mr-3">${getFoodEmoji(f.n)}</div>
                                <div>
                                    <h4 class="font-bold text-xs text-gray-700">${i+1}. ${f.n}</h4>
                                    <p class="text-[10px] text-gray-400">${f.b}</p>
                                </div>
                                <a href="https://www.google.com/search?q=${encodeURIComponent(f.n + ' æ²–ç¹© æ¨è–¦')}" target="_blank" class="ml-auto text-[10px] secondary-text font-bold underline">çœ‹é£Ÿè¨˜</a>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    // ====================================================================
    // 6. WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡)
    // ====================================================================
    async function renderWallet(container) {
        const rate = await updateRealtimeRate();
        const expenses = loadData(LS_KEYS.WALLET, []);
        container.innerHTML = `
            <div class="space-y-6">
                <div class="bg-white p-5 rounded-xl shadow border-l-4 border-yellow-400">
                    <h3 class="font-bold mb-2 text-sm">å³æ™‚åŒ¯ç‡ (JPY â†’ TWD)</h3>
                    <div class="flex justify-between items-center bg-yellow-50 p-2 rounded mb-4">
                        <span class="text-[10px] text-yellow-700">æ›´æ–°æ™‚é–“: ${new Date().toLocaleTimeString()}</span>
                        <b class="primary-text text-sm">1 JPY â‰ˆ ${rate.toFixed(4)} TWD</b>
                    </div>
                    <input id="j-in" type="number" oninput="document.getElementById('t-out').innerText = (this.value * ${rate}).toFixed(0)" placeholder="è¼¸å…¥æ—¥å¹£é‡‘é¡" class="w-full p-3 border rounded-lg text-xl font-bold focus:ring-2 focus:ring-primary outline-none">
                    <p class="mt-2 text-center text-gray-400">â‰ˆ NT$ <span id="t-out" class="primary-text text-2xl font-bold">0</span></p>
                </div>
                <div class="bg-white p-5 rounded-xl shadow">
                    <h3 class="font-bold mb-4">æ–°å¢è¨˜å¸³</h3>
                    <input id="en" placeholder="å“é …åç¨±" class="w-full p-2 border mb-2 rounded text-sm">
                    <input id="ea" type="number" placeholder="é‡‘é¡ (JPY)" class="w-full p-2 border mb-4 rounded text-sm">
                    <button onclick="handleSaveExp()" class="w-full secondary-bg text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜æ¶ˆè²»ç´€éŒ„</button>
                </div>
                <div id="exp-list" class="space-y-2">
                    ${expenses.map(e => `<div class="bg-white p-3 rounded shadow-sm flex justify-between items-center text-sm border-b border-gray-50"><span>${e.n}</span><div class="text-right"><b class="primary-text">${e.a} JPY</b><p class="text-[10px] text-gray-300">${(e.a * rate).toFixed(0)} TWD</p></div></div>`).join('')}
                </div>
            </div>
        `;
    }
    window.handleSaveExp = () => {
        const n = document.getElementById('en').value, a = document.getElementById('ea').value;
        if (!n || !a) return;
        const list = loadData(LS_KEYS.WALLET, []);
        list.unshift({id: Date.now(), n, a});
        saveData(LS_KEYS.WALLET, list);
        switchTab('wallet');
    };

    // ====================================================================
    // 7. LISTS (Checklist + Memos)
    // ====================================================================
    function renderLists(container) {
        const items = loadData(LS_KEYS.CHECKLIST, []);
        const memo = localStorage.getItem(LS_KEYS.MEMOS) || '';
        container.innerHTML = `
            <div class="space-y-6">
                <div class="bg-white p-5 rounded-xl shadow">
                    <h3 class="font-bold mb-4">è¡Œå‰ CheckList</h3>
                    <div class="space-y-3">
                        ${items.map(it => `
                            <div class="flex items-center space-x-3 border-b border-gray-50 pb-2">
                                <input type="checkbox" ${it.checked ? 'checked' : ''} onchange="toggleC('${it.id}')" class="w-5 h-5 accent-pink-400">
                                <span class="${it.checked ? 'line-through text-gray-300' : 'text-gray-700'} text-sm">${it.text}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow">
                    <h3 class="font-bold mb-4 flex items-center text-gray-700"><i class="fa-solid fa-note-sticky mr-2 text-yellow-500"></i>å€‹äººå‚™å¿˜éŒ„</h3>
                    <textarea id="memo-box" oninput="saveM(this.value)" placeholder="åœ¨é€™è£¡å¯«ä¸‹ç­†è¨˜..." class="w-full h-40 p-3 border rounded-xl text-sm text-gray-600 outline-none focus:ring-2 focus:ring-primary transition-all">${memo}</textarea>
                </div>
            </div>
        `;
    }
    window.toggleC = (id) => {
        const list = loadData(LS_KEYS.CHECKLIST, []);
        const it = list.find(x => x.id === id);
        if (it) { it.checked = !it.checked; saveData(LS_KEYS.CHECKLIST, list); renderLists(document.getElementById('app-content')); }
    };
    window.saveM = (v) => localStorage.setItem(LS_KEYS.MEMOS, v);

    // ====================================================================
    // 8. INFO (è³‡è¨Šåˆ†é  - å®Œæ•´åŠŸèƒ½ç‰ˆ)
    // ====================================================================
    function renderInfo(container) {
        container.innerHTML = `
            <div class="space-y-6 pb-4 text-sm">
                <div class="bg-card p-5 rounded-xl shadow border-l-4 border-blue-400">
                    <h2 class="font-bold primary-text mb-3"><i class="fa-solid fa-cloud-sun mr-2"></i>å³æ™‚å¤©æ°£é å ±</h2>
                    <a href="https://www.jma.go.jp/bosai/forecast/#area_type=offices&area_code=471000" target="_blank" class="block w-full text-center py-3 secondary-bg text-white rounded-lg font-bold">æŸ¥çœ‹æ—¥æœ¬æ°£è±¡å»³é å ±</a>
                </div>
                <div class="bg-card p-5 rounded-xl shadow border-l-4 border-green-500">
                    <h2 class="font-bold text-green-600 mb-3"><i class="fa-solid fa-train-subway mr-2"></i>äº¤é€šå·¥å…·</h2>
                    <ul class="space-y-4">
                        <li class="flex justify-between items-center"><span>å–®è»Œé›»è»Š (Yui Rail)</span> <a href="https://www.yui-rail.co.jp/tc/routemap/" target="_blank" class="primary-text underline font-bold">è·¯ç·šåœ–</a></li>
                        <li class="flex justify-between items-center"><span>é‚£éœ¸æ©Ÿå ´å®˜ç¶²</span> <a href="https://www.naha-airport.co.jp/zh-hant/" target="_blank" class="primary-text underline font-bold">å³æ™‚èˆªç­</a></li>
                    </ul>
                </div>
                <div class="bg-card p-5 rounded-xl shadow border-l-4 border-red-500">
                    <h2 class="font-bold text-red-600 mb-2"><i class="fa-solid fa-phone-flip mr-2"></i>ç·Šæ€¥æ”¯æ´</h2>
                    <div class="flex justify-between mb-1"><span>è­¦å¯Ÿå±€ / æ•‘è­·è»Š</span> <b class="text-red-500">110 / 119</b></div>
                    <div class="flex justify-between mt-2 pt-2 border-t border-gray-100"><span>é§é‚£éœ¸è¾¦äº‹è™•</span> <a href="tel:+81988627008" class="font-bold underline text-blue-500">098-862-7008</a></div>
                </div>
                <div class="bg-card p-5 rounded-xl shadow border-l-4 border-purple-400">
                    <h2 class="font-bold text-purple-600 mb-2"><i class="fa-solid fa-language mr-2"></i>ç”Ÿå­˜æ—¥èª</h2>
                    <div class="text-xs grid grid-cols-2 gap-3 italic">
                        <p><b>Sumimasen:</b> ä¸å¥½æ„æ€</p><p><b>Arigato:</b> è¬è¬</p>
                        <p><b>Okaikei:</b> çµå¸³</p><p><b>Toire:</b> å»æ‰€</p>
                    </div>
                </div>
            </div>
        `;
    }

    // --- MODAL & CRUD UTILS ---
    function cMod(id, title, body, onConfirm) {
        const m = document.createElement('div'); m.id = id; m.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
        m.innerHTML = `<div class="bg-white p-6 rounded-xl w-full max-w-xs shadow-2xl"><h3 class="font-bold mb-4 border-b pb-2">${title}</h3>${body}<div class="flex justify-end space-x-3 mt-6 border-t pt-4"><button onclick="closeModal('${id}')" class="text-gray-400 text-sm">å–æ¶ˆ</button><button id="${id}-btn" class="primary-bg text-white px-4 py-1 rounded-lg text-sm">ç¢ºèª</button></div></div>`;
        document.body.appendChild(m); document.getElementById(`${id}-btn`).onclick = onConfirm;
    }
    function closeModal(id) { const el = document.getElementById(id); if(el) el.remove(); }
    window.closeModal = closeModal;

    window.showAddDayModal = () => {
        const b = `<input id="my" placeholder="D6" class="w-full p-2 border mb-2 text-sm"><input id="md" placeholder="03/12" class="w-full p-2 border mb-2 text-sm"><input id="mo" type="number" value="${cloudItineraryData.length+1}" class="w-full p-2 border text-sm">`;
        cMod('ad', 'æ–°å¢è¡Œç¨‹æ—¥', b, () => { firebaseModules.addDoc(getColRef(), { day: document.getElementById('my').value, date: document.getElementById('md').value, order: parseInt(document.getElementById('mo').value), events: [] }); closeModal('ad'); });
    }
    window.showEditDayModal = (id, y, d, o) => {
        const b = `<input id="ey" value="${y}" class="w-full p-2 border mb-2 text-sm"><input id="ed" value="${d}" class="w-full p-2 border mb-2 text-sm"><input id="eo" type="number" value="${o}" class="w-full p-2 border text-sm">`;
        cMod('ed', 'ç·¨è¼¯', b, () => { firebaseModules.updateDoc(firebaseModules.doc(getColRef(), id), { day: document.getElementById('ey').value, date: document.getElementById('ed').value, order: parseInt(document.getElementById('eo').value) }); closeModal('ed'); });
    }
    window.confirmDelDay = (id) => cMod('dl', 'åˆªé™¤', `<p class="text-sm">ç¢ºå®šåˆªé™¤é€™å¤©ï¼Ÿ</p>`, () => { firebaseModules.deleteDoc(firebaseModules.doc(getColRef(), id)); closeModal('dl'); });
    
    window.showAddEvModal = (id) => {
        const b = `<input id="at" placeholder="æ™‚é–“" class="w-full p-2 border mb-2 text-sm"><input id="an" placeholder="æ´»å‹•" class="w-full p-2 border mb-2 text-sm"><input id="al" placeholder="åœ°é»" class="w-full p-2 border mb-2 text-sm"><select id="ay" class="w-full p-2 border text-sm"><option value="activity">æ´»å‹•</option><option value="food">ç¾é£Ÿ</option><option value="highlight">æé†’</option><option value="sight">æ™¯é»</option></select>`;
        cMod('ae', 'æ–°å¢æ´»å‹•', b, () => { const d = cloudItineraryData.find(x => x.docId === id); const events = [...(d.events || []), { time: document.getElementById('at').value, name: document.getElementById('an').value, location: document.getElementById('al').value, type: document.getElementById('ay').value }].sort((a,b)=>a.time.localeCompare(b.time)); firebaseModules.updateDoc(firebaseModules.doc(getColRef(), id), { events }); closeModal('ae'); });
    }
    window.showEditEventModal = (id, idx) => {
        const ev = cloudItineraryData.find(d => d.docId === id).events[idx];
        const b = `<input id="et" value="${ev.time}" class="w-full p-2 border mb-2 text-sm"><input id="en" value="${ev.name}" class="w-full p-2 border mb-2 text-sm"><input id="el" value="${ev.location||''}" class="w-full p-2 border mb-2 text-sm">`;
        cMod('ee', 'ç·¨è¼¯æ´»å‹•', b, () => { 
            const d = cloudItineraryData.find(x => x.docId === id); 
            const events = [...d.events]; 
            events[idx] = { ...ev, time: document.getElementById('et').value, name: document.getElementById('en').value, location: document.getElementById('el').value }; 
            events.sort((a,b)=>a.time.localeCompare(b.time)); 
            firebaseModules.updateDoc(firebaseModules.doc(getColRef(), id), { events }); 
            closeModal('ee'); 
        });
    }
    window.confirmDelEv = (id, idx, name) => cMod('de', 'ç§»é™¤', `<p class="text-sm">ç¢ºå®šç§»é™¤ï¼š${name}ï¼Ÿ</p>`, () => { const d = cloudItineraryData.find(x => x.docId === id); const events = d.events.filter((_, i) => i !== idx); firebaseModules.updateDoc(firebaseModules.doc(getColRef(), id), { events }); closeModal('de'); });

    window.showMapModal = (loc, title) => {
        const m = document.getElementById('map-modal');
        document.getElementById('map-modal-title').innerText = title;
        document.getElementById('map-external-link').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc + ' æ²–ç¹©')}`;
        m.classList.remove('hidden'); setTimeout(() => m.classList.replace('opacity-0', 'opacity-100'), 10);
    }
    window.closeMapModal = () => { const m = document.getElementById('map-modal'); m.classList.replace('opacity-100', 'opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); }

    window.onload = () => {
        initializeStorage();
        if (typeof window.initFirebaseAndAuth === 'function') window.initFirebaseAndAuth();
        switchTab(localStorage.getItem(LS_KEYS.CURRENT_TAB) || 'plan');
    };
</script>
</body>
</html>