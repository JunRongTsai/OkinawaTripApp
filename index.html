<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦ªæ„æ—…ç¨‹ | æ²–ç¹©é›²ç«¯å”ä½œåŠ©æ‰‹</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC for Zen/Minimalist look -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK Modules for Cloud Features -->
    <!-- æ³¨æ„ï¼šæ­¤è™•å¿…é ˆä½¿ç”¨ type="module" -->
    <script type="module">
        // ç¢ºä¿ Firebase API æ¨¡çµ„åŒ–å°å…¥
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®šå…¨åŸŸè®Šæ•¸ä»¥ä¾›å…¶ä»– script å€å¡Šå­˜å–
        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy,
            setLogLevel
        };
        
        // å…¨åŸŸç‹€æ…‹ï¼šFirebase èªè­‰æ˜¯å¦æº–å‚™å°±ç·’
        window.isAuthReady = false; 
        window.authError = null; // å„²å­˜èªè­‰éŒ¯èª¤è¨Šæ¯

        // =========================================================================
        // !!! FIREBASE é›²ç«¯é€£ç·šè¨­å®š (å·²æ›´æ–°ç‚ºæ‚¨æä¾›çš„æ­£ç¢º Config) !!!
        // =========================================================================
        
        // 1. è¨­å®š App ID (ç”¨æ–¼ Firestore è·¯å¾‘ artifacts/{appId}/public/data/itineraries)
        const APP_ID_FOR_NETLIFY = 'okinawa-group-trip-2026'; 

        // 2. å¡«å…¥æ‚¨åœ¨ Firebase Console ç²å–çš„ Web App è¨­å®š (æœ€æ–°ç‰ˆ)
        const FIREBASE_CONFIG_FOR_NETLIFY = {
             // æ­¤è™•ç‚ºæ‚¨æä¾›çš„æœ€æ–°ã€æœ€æ­£ç¢ºçš„ API Key
             apiKey: "AIzaSyDc7dkeG9RJcmyuNv2ZYDZEtkTUwNWAYek",
             authDomain: "travelapp-b382d.firebaseapp.com",
             projectId: "travelapp-b382d",
             storageBucket: "travelapp-b382d.firebasestorage.app",
             messagingSenderId: "579137022414",
             appId: "1:579137022414:web:890bcdc6ffa6e25f5da39f",
             measurementId: "G-T0YDHHG7DN"
        };
        
        // åœ¨ Netlify ç’°å¢ƒä¸­ï¼Œç›´æ¥ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„é…ç½®
        const appId = APP_ID_FOR_NETLIFY; 
        const firebaseConfig = FIREBASE_CONFIG_FOR_NETLIFY;
        const initialAuthToken = null; 
        
        // æª¢æŸ¥è¨­å®šæ˜¯å¦ç‚ºé è¨­çš„ Placeholder
        let firebaseReady = false;
        if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE" || !firebaseConfig.apiKey) {
            console.error("FIREBASE CONFIG ERROR: Missing API key.");
            // è¨­å®š Dummy Objects é¿å…å¾ŒçºŒ function æ‹‹å‡º undefined éŒ¯èª¤
            window.db = {}; 
            window.auth = { currentUser: { uid: 'placeholder-uid' } };
            window.appId = appId;
        } else {
            // Initialization proceeds only if config seems valid
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('debug'); 
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            firebaseReady = true;
        }
        // =========================================================================


        // èªè­‰é‚è¼¯
        async function initFirebaseAndAuth() {
            if (!firebaseReady) {
                console.log("Skipping Firebase Auth due to missing configuration.");
                return;
            }
            
            try {
                // ä½¿ç”¨åŒ¿åç™»å…¥
                await signInAnonymously(auth);
                console.log("Firebase: Signed in anonymously.");

                const userId = auth.currentUser?.uid || crypto.randomUUID();
                window.userId = userId;

                // ç‹€æ…‹è®Šæ›´æ™‚æ¨™è¨˜èªè­‰å®Œæˆ
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Auth State Ready. Current User ID:", user.uid);
                        window.isAuthReady = true; 
                        // å¦‚æœåœ¨ PLAN é é¢ï¼Œèªè­‰å®Œæˆå¾Œé‡æ–°æ¸²æŸ“
                        if (localStorage.getItem('zenTravelApp_currentTab') === 'plan') {
                            switchTab('plan'); 
                        }
                    } else {
                        console.log("Auth State changed: No user signed in.");
                    }
                });

            } catch (error) {
                console.error("Firebase Auth Error:", error);
                // æ•ç²éŒ¯èª¤ä¸¦è¨­ç½®æ˜ç¢ºçš„éŒ¯èª¤ç¢¼
                window.authError = { code: error.code, message: error.message };
                
                window.isAuthReady = true; 
                // å³ä½¿å¤±æ•—ï¼Œä¹Ÿè¦é‡æ–°æ¸²æŸ“ PLAN é é¢ä»¥é¡¯ç¤ºéŒ¯èª¤æç¤º
                if (localStorage.getItem('zenTravelApp_currentTab') === 'plan') {
                    switchTab('plan'); 
                }
            }
        }

        window.initFirebaseAndAuth = initFirebaseAndAuth;
    </script>


    <style>
        :root {
            /* ä¸»è‰²: æŸ”å’Œçš„ç´…æ£•è‰²/é®­é­šç²‰ (Salmon/Red-Brown) */
            --color-primary: #C89088;
            /* æ¬¡è‰²: æŸ”å’Œçš„å¢¨ç¶ è‰² (Muted Green) */
            --color-secondary: #8D9B8B;
            /* èƒŒæ™¯è‰²: å¥¶æ²¹ç™½/ç±³ç™½ (Creamy White) */
            --color-background: #F7F3E8;
            /* å¡ç‰‡èƒŒæ™¯è‰² */
            --color-card: #FFFFFF;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-background);
            padding-bottom: 72px; /* åº•éƒ¨å°èˆªåˆ—é«˜åº¦ */
        }

        /* è‡ªå®šç¾© Tailwind è¨­å®š */
        .primary-bg { background-color: var(--color-primary); }
        .primary-text { color: var(--color-primary); }
        .secondary-bg { background-color: var(--color-secondary); }
        .secondary-text { color: var(--color-secondary); }
        .bg-card { background-color: var(--color-card); }

        .nav-icon {
            transition: color 0.2s;
        }

        /* è¡Œç¨‹æ™‚é–“è»¸æ¨£å¼ */
        .timeline-item {
            position: relative;
            padding-left: 20px;
            border-left: 2px solid #D1D5DB; /* ç°è‰²ç·šæ¢ */
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--color-secondary);
            border: 3px solid var(--color-background);
        }

        .timeline-highlight::before {
             background-color: var(--color-primary) !important;
             border: 3px solid var(--color-background);
        }

        /* éš±è—åŸç”Ÿæª”æ¡ˆè¼¸å…¥æ¡† */
        .file-input-hidden {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        /* æ»¾å‹•æ¢ç¾åŒ– (Webkit/Chrome) */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--color-secondary);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-track {
            background-color: var(--color-background);
        }
        /* åœ°åœ– Modal æ¨£å¼ */
        .modal-iframe-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
        }

        .modal-iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }

    </style>
</head>
<body class="min-h-screen">

    <!-- Header é ‚éƒ¨æ¨™é¡Œ (Mobile-First) -->
    <header class="fixed top-0 left-0 right-0 bg-card shadow-lg p-4 z-10">
        <h1 id="app-title" class="text-xl font-bold primary-text text-center">æ—…ç¨‹è¦åŠƒ (PLAN)</h1>
    </header>

    <!-- ä¸»å…§å®¹å€åŸŸ -->
    <main id="app-content" class="pt-[64px] pb-4 px-4"></main>
    
    <!-- Loading Modal (ç”¨æ–¼ API è«‹æ±‚æˆ–è€—æ™‚æ“ä½œ) -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-card p-6 rounded-xl shadow-2xl flex items-center primary-text">
            <i class="fas fa-spinner fa-spin mr-3"></i>
            <span id="loading-message">è¼‰å…¥ä¸­...</span>
        </div>
    </div>
    
    <!-- åœ°åœ– Modal çµæ§‹ (å·²ç°¡åŒ–ç‚ºå½ˆçª—æç¤º) -->
    <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 transition-opacity duration-300 opacity-0 hidden">
        <div class="bg-card w-full max-w-sm rounded-xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <h3 id="map-modal-title" class="text-xl font-bold primary-text mb-4 border-b pb-2">åœ°é»åœ°åœ–</h3>
            <p class="text-gray-700 mb-6">å³å°‡é–‹å•Ÿ <span id="map-location-text" class="font-bold secondary-text"></span> çš„åœ°åœ–æ‡‰ç”¨ç¨‹å¼ã€‚</p>
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <a id="map-external-link" target="_blank" class="secondary-bg text-white px-4 py-2 rounded-lg font-bold hover:opacity-90 flex items-center">
                    <i class="fa-solid fa-external-link-alt mr-2"></i> å‰å¾€åœ°åœ– App
                </a>
                <button onclick="closeModal('map-modal')" class="text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-100">å–æ¶ˆ</button>
            </div>
        </div>
    </div>


    <!-- åº•éƒ¨å°èˆªåˆ— (Fixed Bottom Navigation) -->
    <nav class="fixed bottom-0 left-0 right-0 h-16 primary-bg shadow-2xl z-20 flex justify-around items-center">
        <button onclick="switchTab('plan')" class="nav-icon text-card focus:outline-none flex flex-col items-center justify-center p-2">
            <i class="fa-solid fa-calendar-alt text-xl"></i>
            <span class="text-xs mt-1">è¡Œç¨‹è¡¨</span>
        </button>
        <button onclick="switchTab('guide')" class="nav-icon text-card focus:outline-none flex flex-col items-center justify-center p-2">
            <i class="fa-solid fa-compass text-xl"></i>
            <span class="text-xs mt-1">å°è¦½</span>
        </button>
        <button onclick="switchTab('wallet')" class="nav-icon text-card focus:outline-none flex flex-col items-center justify-center p-2">
            <i class="fa-solid fa-wallet text-xl"></i>
            <span class="text-xs mt-1">è¨˜å¸³</span>
        </button>
        <button onclick="switchTab('lists')" class="nav-icon text-card focus:outline-none flex flex-col items-center justify-center p-2">
            <i class="fa-solid fa-list-check text-xl"></i>
            <span class="text-xs mt-1">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('info')" class="nav-icon text-card focus:outline-none flex flex-col items-center justify-center p-2">
            <i class="fa-solid fa-circle-info text-xl"></i>
            <span class="text-xs mt-1">è³‡è¨Š</span>
        </button>
    </nav>

<script>
    // ====================================================================
    // 1. å…¨åŸŸè¨­å®šèˆ‡è³‡æ–™æ¨¡å‹ (Global Setup and Data Model)
    // ====================================================================

    // åŒ¯ç‡è¨­å®š (æ—¥å¹£ JPY æ›ç®—ç‚º å°å¹£ TWD)
    const TWD_RATE_KEY = 'zenTravelApp_TWD_RATE';
    const initialRate = 0.215; // åˆå§‹åŒ¯ç‡ï¼š 1 JPY = 0.215 TWD

    // LocalStorage Keys (è¨˜å¸³å’Œæ¸…å–®ä»ä½¿ç”¨ LocalStorage)
    const LS_KEYS = {
        WALLET: 'zenTravelApp_wallet',
        CHECKLIST: 'zenTravelApp_checklist',
        MEMOS: 'zenTravelApp_memos',
        CURRENT_TAB: 'zenTravelApp_currentTab'
    };

    // é›²ç«¯è¡Œç¨‹è³‡æ–™ (å°‡å¾ Firestore è®€å–)
    let cloudItineraryData = [];
    let unsubscribeItinerary = null; // ç”¨æ–¼å„²å­˜ Firestore ç›£è½å™¨
    window.authError = null; // New: å„²å­˜èªè­‰éŒ¯èª¤è¨Šæ¯

    // æ—…éŠè³‡è¨Š (ç”¨æ–¼åˆå§‹åŒ–å’Œéœæ…‹é é¢)
    const STATIC_TRAVEL_DATA = {
        // èˆªç­è³‡è¨Š
        flight: {
            outbound: "IT288 (KHH 09:45 â†’ OKA 12:30)", // è‡ºç£è™èˆª KHH -> OKA
            return: "CI133 (OKA 19:30 â†’ KHH 20:25)" // ä¸­è¯èˆªç©º OKA -> KHH
        },
        // ä½å®¿è³‡è¨Š
        accommodation: {
            name: "é‚£éœ¸ç¸£å»³å‰é˜¿çˆ¾è’™ç‰¹ (Almont Hotel Naha-Kenchomae)",
            address: "æ²–ç¹©ç¸£é‚£éœ¸å¸‚ä¹…èŒ‚åœ° 1-3-5 (è¿‘åœ‹éš›é€š)"
        },
        // å¿…å‚™æ¸…å–® (å·²ç§»é™¤è‡ªé§•ç›¸é—œ)
        prepList: [
            "è­·ç…§ã€ç°½è­‰", "æ—¥å¹£ç¾é‡‘ã€ä¿¡ç”¨å¡", "ç¶²å¡/eSIM/Wifiæ©Ÿ", "å……é›»å™¨ã€è½‰æ¥é ­", "é›¨å…·ã€å¤–å¥—",
            "å€‹äººè—¥å“", "æ›æ´—è¡£ç‰©", "æ—…éŠä¿éšªå–®", "é›»å­æ©Ÿç¥¨/è¨‚æˆ¿ç¢ºèªå–®"
        ]
    };

    // é è¨­è¡Œç¨‹ (é‚£éœ¸ç‚ºä¸», æ­¥è¡Œ/å¤§çœ¾äº¤é€š) - åƒ…ç”¨æ–¼ Firestore é¦–æ¬¡è¼‰å…¥ç©ºå€¼æ™‚çš„åˆå§‹åŒ–åƒè€ƒ
    const DEFAULT_ITINERARY = [
        { id: 'D1', day: 'D1 (æŠµé”/å¸‚å€)', date: '03/07 (å…­)', order: 1, events: [
            { time: '12:30', name: 'æŠµé”æ²–ç¹©é‚£éœ¸æ©Ÿå ´ (OKA)', type: 'info' },
            { time: '14:30', name: 'Check-in é£¯åº— (é‚£éœ¸ç¸£å»³å‰é˜¿çˆ¾è’™ç‰¹)', type: 'info', location: 'æ²–ç¹©ç¸£é‚£éœ¸å¸‚ä¹…èŒ‚åœ° 1-3-5' },
            { time: '17:00', name: 'åœ‹éš›é€šæ•£ç­–èˆ‡è³¼ç‰©', type: 'activity', location: 'åœ‹éš›é€š' },
            { time: '19:30', name: 'æ™šé¤ï¼šç‰çƒç‰¹è‰²æ–™ç† (é‡è¦é›†åˆæ™‚é–“)', type: 'highlight', location: 'åœ‹éš›é€š' }
        ]},
        { id: 'D2', day: 'D2 (æµ·æ´‹/æ°´æ—é¤¨)', date: '03/08 (æ—¥)', order: 2, events: [
            { time: '09:00', name: 'æ­ä¹˜é«˜é€Ÿå·´å£«å‰å¾€æµ·æ´‹åšå…¬åœ’ (æ°´æ—é¤¨)', type: 'highlight', location: 'åè­·' },
            { time: '11:00', name: 'æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨ (Churaumi Aquarium)', type: 'sight', location: 'æµ·æ´‹åšå…¬åœ’' },
            { time: '16:00', name: 'è§€è³æµ·è±šè¡¨æ¼” (Ocean Expo Park)', type: 'sight' },
            { time: '19:30', name: 'è¿”å›é‚£éœ¸å¸‚å€', type: 'info' }
        ]},
        { id: 'D3', day: 'D3 (æ–‡åŒ–/è³¼ç‰©)', date: '03/09 (ä¸€)', order: 3, events: [
            { time: '10:00', name: 'æ³¢ä¸Šå®® (æµ·é‚Šç¥ç¤¾)', type: 'sight', location: 'æ³¢ä¸Šå®®' },
            { time: '12:00', name: 'åˆé¤ï¼šç‰çƒèŒ¶æˆ¿ (æŸ¥çœ‹é£Ÿè¨˜)', type: 'food', location: 'ç‰çƒèŒ¶æˆ¿' },
            { time: '15:00', name: 'æ­ä¹˜å–®è»Œé›»è»Šè‡³å°ç¥¿ç«™', type: 'info' },
            { time: '15:30', name: 'AEON Mall / Ashibinaa Outlet è³¼ç‰©', type: 'activity', location: 'Ashibinaa Outlet' }
        ]},
        { id: 'D4', day: 'D4 (å¸‚å€/æ…¢æ´»)', date: '03/10 (äºŒ)', order: 4, events: [
            { time: '10:30', name: 'é¦–é‡ŒåŸå…¬åœ’ (æ­ä¹˜å–®è»Œé›»è»Š)', type: 'sight', location: 'é¦–é‡ŒåŸ' },
            { time: '13:00', name: 'é¦–é‡Œé‡‘åŸç”ºçŸ³ç–Šé“æ•£æ­¥', type: 'sight' },
            { time: '16:00', name: 'é‚£éœ¸åœ‹éš›é€šå‘¨é‚Šå’–å•¡å»³ä¼‘æ¯', type: 'activity' },
            { time: '19:00', name: 'æ™šé¤ï¼šåœ‹éš›é€šå‘¨é‚Šç¾é£Ÿæ¢ç´¢ (TOP10)', type: 'food', location: 'åœ‹éš›é€š' }
        ]},
        { id: 'D5', day: 'D5 (è¿”ç¨‹)', date: '03/11 (ä¸‰)', order: 5, events: [
            { time: '10:00', name: 'é£¯åº— Check-out / å¯„æ”¾è¡Œæ', type: 'info' },
            { time: '12:00', name: 'é‚£éœ¸å¸‚å€åˆé¤èˆ‡æœ€çµ‚æ¡è²·', type: 'activity', location: 'åœ‹éš›é€š' },
            { time: '16:00', name: 'å–è¡Œæï¼Œå‰å¾€é‚£éœ¸æ©Ÿå ´ (OKA)', type: 'highlight' },
            { time: '19:30', name: 'CI133 é£›æ©Ÿèµ·é£› (OKA â†’ KHH)', type: 'info' }
        ]}
    ];

    // ====================================================================
    // 2. LocalStorage å­˜å–èˆ‡åˆå§‹åŒ– (Storage & Init)
    // ====================================================================

    // è¼‰å…¥è³‡æ–™ (é€šç”¨ - åƒ…ç”¨æ–¼ LocalStorage)
    function loadData(key, defaultVal) {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultVal;
    }

    // å„²å­˜è³‡æ–™ (é€šç”¨ - åƒ…ç”¨æ–¼ LocalStorage)
    function saveData(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    }

    // åˆå§‹åŒ– LocalStorage è³‡æ–™
    function initializeStorage() {
        if (!localStorage.getItem(LS_KEYS.CHECKLIST)) {
            const initialChecklist = STATIC_TRAVEL_DATA.prepList.map(item => ({
                id: crypto.randomUUID(),
                text: item,
                checked: false
            }));
            saveData(LS_KEYS.CHECKLIST, initialChecklist);
        }

        if (!localStorage.getItem(LS_KEYS.WALLET)) {
            saveData(LS_KEYS.WALLET, []);
        }

        if (!localStorage.getItem(LS_KEYS.MEMOS)) {
            saveData(LS_KEYS.MEMOS, []);
        }

        if (!localStorage.getItem(TWD_RATE_KEY)) {
            localStorage.setItem(TWD_RATE_KEY, initialRate.toString());
        }
    }

    // ====================================================================
    // 3. ç•«é¢åˆ‡æ›èˆ‡å°èˆª (Tab Switching)
    // ====================================================================

    const TABS = {
        plan: { title: 'æ—…ç¨‹è¦åŠƒ (PLAN - é›²ç«¯å”ä½œ)', renderer: renderPlan },
        guide: { title: 'æ·±åº¦å°è¦½ (GUIDE - æ²–ç¹©TOP10)', renderer: renderGuide },
        wallet: { title: 'è¨˜å¸³èˆ‡åŒ¯ç‡ (WALLET - å€‹äººç´€éŒ„)', renderer: renderWallet },
        lists: { title: 'æ¸…å–®èˆ‡å‚™å¿˜ (LISTS - å€‹äººç´€éŒ„)', renderer: renderLists },
        info: { title: 'å¯¦ç”¨è³‡è¨Š (INFO)', renderer: renderInfo }
    };

    function switchTab(tabName) {
        const contentArea = document.getElementById('app-content');
        const titleArea = document.getElementById('app-title');
        const navButtons = document.querySelectorAll('.nav-icon');

        if (!TABS[tabName]) return;

        // åœæ­¢èˆŠçš„ Firestore ç›£è½å™¨
        if (unsubscribeItinerary) {
            unsubscribeItinerary();
            unsubscribeItinerary = null;
            console.log("Firestore: Unsubscribed from previous Plan listener.");
        }

        // æ›´æ–°å°èˆªåˆ—æ¨£å¼
        navButtons.forEach(btn => {
            const isActive = btn.getAttribute('onclick').includes(`'${tabName}'`);
            btn.classList.toggle('primary-bg', isActive);
            btn.classList.toggle('text-card', isActive);
            btn.classList.toggle('text-white', !isActive);
            btn.classList.toggle('bg-white/10', !isActive);
        });

        // æ›´æ–°æ¨™é¡Œ
        titleArea.textContent = TABS[tabName].title;
        // æ¸…ç©ºä¸¦æ¸²æŸ“å…§å®¹
        contentArea.innerHTML = '';
        TABS[tabName].renderer(contentArea);

        // å„²å­˜ç•¶å‰ Tab
        localStorage.setItem(LS_KEYS.CURRENT_TAB, tabName);
    }

    // ====================================================================
    // 4. PLAN (è¡Œç¨‹è¡¨ - FIREBASE é›²ç«¯å”ä½œ) æ¸²æŸ“èˆ‡é‚è¼¯
    // ====================================================================

    function getItineraryCollectionRef() {
        if (typeof db === 'undefined' || typeof appId === 'undefined' || !window.db.app) {
            console.error("Firestore or App ID not initialized.");
            return null;
        }
        // å…¬å…±è³‡æ–™è·¯å¾‘: /artifacts/{appId}/public/data/itineraries
        return firebaseModules.collection(db, `artifacts/${appId}/public/data/itineraries`);
    }

    // å¯¦æ™‚ç²å–è¡Œç¨‹æ•¸æ“š
    function fetchItineraryRealtime(container) {
        // æª¢æŸ¥æ˜¯å¦å› é…ç½®éŒ¯èª¤è€Œè·³éåˆå§‹åŒ– (Case 1: Placeholder key)
        if (typeof window.db === 'object' && !window.db.app) {
             container.innerHTML = `
                <div class="text-center p-8 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-xl shadow-md">
                    <i class="fa-solid fa-triangle-exclamation text-2xl mb-3"></i>
                    <p class="font-bold mb-2">é›²ç«¯é€£ç·šå¤±æ•—ï¼šè«‹è¨­å®š Firebase</p>
                    <p class="text-sm">è«‹ç·¨è¼¯æ­¤ HTML æª”æ¡ˆï¼Œä¸¦åœ¨é–‹é ­çš„ &lt;script type="module"&gt; å€å¡Šä¸­ï¼Œå°‡ **YOUR_API_KEY_HERE** æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆè¨­å®šã€‚</p>
                </div>
             `;
             return;
        }

        // æª¢æŸ¥æ˜¯å¦å› ç‚ºèªè­‰å¤±æ•— (Case 2: Invalid API key/Auth disabled)
        if (window.authError) {
             const errorHtml = `
                <div class="text-center p-8 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-xl shadow-md">
                    <i class="fa-solid fa-link-slash text-2xl mb-3"></i>
                    <p class="font-bold mb-2">é›²ç«¯é€£ç·šå¤±æ•—ï¼šèªè­‰éŒ¯èª¤</p>
                    <p class="text-sm">Firebase å›å‚³éŒ¯èª¤ï¼š<code>${window.authError.code || 'é€£ç·šç•°å¸¸'}</code></p>
                    <p class="text-xs mt-2 font-bold">è«‹æª¢æŸ¥æ‚¨çš„ Firebase Consoleï¼š</p>
                    <ul class="text-xs list-disc list-inside mt-1 mx-auto max-w-xs text-left">
                        <li>**Authentication**ï¼šç¢ºä¿å·²å•Ÿç”¨ **åŒ¿åç™»å…¥ (Anonymous)** æ–¹æ³•ã€‚</li>
                        <li>**Config è³‡è¨Š**ï¼šå†æ¬¡æª¢æŸ¥ HTML ä¸­çš„ **apiKey** å’Œ **projectId** æ˜¯å¦å®Œæ•´è²¼ä¸Šã€‚</li>
                        <li>**ç¶²åŸŸæˆæ¬Š**ï¼šåœ¨ Auth è¨­å®šä¸­ï¼Œå°‡æ‚¨çš„ Netlify ç¶²å€åŠ å…¥ **æˆæ¬Šç¶²åŸŸ (Authorized Domains)**ã€‚</li>
                        <li>**Firestore è¦å‰‡**ï¼šç¢ºä¿å…¬å…±è·¯å¾‘ (\`/artifacts/{appId}/public/...\`) å…è¨±è®€å¯«ã€‚</li>
                    </ul>
                </div>
             `;
             container.innerHTML = errorHtml;
             return;
        }

        const itineraryRef = getItineraryCollectionRef();
        if (!itineraryRef) {
             container.innerHTML = '<p class="text-center text-red-500 p-8">é›²ç«¯è³‡æ–™åº«æœªé€£ç·šæˆ–é©—è­‰å¤±æ•—ï¼Œç„¡æ³•è¼‰å…¥è¡Œç¨‹ã€‚</p>';
             return;
        }

        // è¨­ç½® Loading ç‹€æ…‹
        container.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-3xl primary-text"></i>
                <p class="mt-4 text-gray-600">æ­£åœ¨åŒæ­¥é›²ç«¯è¡Œç¨‹æ•¸æ“š...</p>
            </div>
        `;


        // è¨­ç½® Firestore å¯¦æ™‚ç›£è½å™¨
        const q = firebaseModules.query(itineraryRef, firebaseModules.orderBy('order', 'asc'));

        unsubscribeItinerary = firebaseModules.onSnapshot(q, (snapshot) => {
            console.log("Firestore: Itinerary data received.");
            cloudItineraryData = snapshot.docs.map(doc => ({
                ...doc.data(),
                docId: doc.id
            }));

            // å¦‚æœé›²ç«¯æ•¸æ“šç‚ºç©ºï¼Œå‰‡ä½¿ç”¨é è¨­è¡Œç¨‹åˆå§‹åŒ–é›²ç«¯
            if (cloudItineraryData.length === 0) {
                console.log("Firestore: Cloud is empty, initializing with default itinerary.");
                DEFAULT_ITINERARY.forEach(dayPlan => {
                     // ä½¿ç”¨ setDoc ç¢ºä¿ Doc ID ç‚º D1, D2...
                    firebaseModules.setDoc(firebaseModules.doc(itineraryRef, dayPlan.id), dayPlan)
                    .catch(e => console.error("Error setting default itinerary:", e));
                });
                return; // ç­‰å¾…ä¸‹ä¸€å€‹ Snapshot è§¸ç™¼æ¸²æŸ“
            }

            renderItineraryUI(container, cloudItineraryData);

        }, (error) => {
            console.error("Firestore Realtime Listener Error:", error);
            container.innerHTML = `<p class="text-center text-red-500 p-8">é›²ç«¯åŒæ­¥éŒ¯èª¤: ${error.message}</p>`;
        });
    }

    function renderPlan(container) {
        // å¦‚æœèªè­‰æµç¨‹å°šæœªå®Œæˆï¼Œå‰‡é¡¯ç¤ºç­‰å¾…è¨Šæ¯
        if (!window.isAuthReady) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-3xl secondary-text"></i>
                    <p class="mt-4 text-gray-600">æ­£åœ¨é©—è­‰é›²ç«¯èº«ä»½ï¼Œè«‹ç¨å€™...</p>
                </div>
            `;
            // åœ¨ç­‰å¾…æ™‚ï¼Œå˜—è©¦åœ¨èƒŒæ™¯åŸ·è¡Œèªè­‰ï¼Œä»¥ä¾¿å®Œæˆå¾Œå¯ä»¥è‡ªå‹•è¼‰å…¥
            if (typeof window.initFirebaseAndAuth === 'function') {
                window.initFirebaseAndAuth();
            }
            return;
        }

        // æ¸²æŸ“é ‚éƒ¨è³‡è¨Š
        const infoHtml = `
            <div class="mb-6 space-y-4">
                <div class="p-4 bg-white rounded-xl shadow-md border-l-4 border-blue-400">
                    <h3 class="font-bold text-gray-700 mb-1"><i class="fa-solid fa-plane-up mr-2"></i>èˆªç­è³‡è¨Š (é«˜é›„ KHH â‡Œ æ²–ç¹© OKA)</h3>
                    <p class="text-sm text-gray-600">å»ç¨‹: ${STATIC_TRAVEL_DATA.flight.outbound}</p>
                    <p class="text-sm text-gray-600">å›ç¨‹: ${STATIC_TRAVEL_DATA.flight.return}</p>
                </div>
                <div class="p-4 bg-white rounded-xl shadow-md border-l-4 border-yellow-400">
                    <h3 class="font-bold text-gray-700 mb-1"><i class="fa-solid fa-hotel mr-2"></i>ä½å®¿è³‡è¨Š (4æ™š)</h3>
                    <p class="text-sm text-gray-600">${STATIC_TRAVEL_DATA.accommodation.name}</p>
                    <p class="text-xs text-gray-500 mt-1">${STATIC_TRAVEL_DATA.accommodation.address}</p>
                </div>
                <div class="text-center pt-2">
                    <button onclick="showAddDayModal()" class="primary-bg text-white px-4 py-2 rounded-full font-bold shadow-md hover:opacity-90">
                        <i class="fa-solid fa-plus mr-1"></i> æ–°å¢è¡Œç¨‹æ—¥
                    </button>
                </div>
            </div>
            <div id="itinerary-list"></div>
        `;
        container.innerHTML = infoHtml;
        fetchItineraryRealtime(document.getElementById('itinerary-list'));
    }

    // æ¸²æŸ“è¡Œç¨‹åˆ—è¡¨ (ç”± onSnapshot è§¸ç™¼)
    function renderItineraryUI(container, data) {
        const listHtml = data.map(dayPlan => `
            <div class="mb-8 p-4 bg-card rounded-xl shadow-lg border border-gray-100 relative" data-doc-id="${dayPlan.docId}">
                 <div class="absolute top-3 right-3 flex space-x-2">
                    <button onclick="showEditDayModal('${dayPlan.docId}', '${dayPlan.day}', '${dayPlan.date}', ${dayPlan.order})" class="text-gray-500 hover:text-blue-600"><i class="fa-solid fa-edit text-sm"></i></button>
                    <button onclick="confirmDeleteDay('${dayPlan.docId}', '${dayPlan.day}')" class="text-gray-500 hover:text-red-600"><i class="fa-solid fa-trash-alt text-sm"></i></button>
                </div>
                <!-- æ—¥æœŸæ¨™é¡Œ -->
                <div class="flex items-center mb-4 pb-2 border-b border-gray-200">
                    <span class="secondary-bg text-white font-bold text-sm px-3 py-1 rounded-full mr-3">${dayPlan.day}</span>
                    <h2 class="text-lg font-medium secondary-text">${dayPlan.date}</h2>
                </div>

                <!-- è¡Œç¨‹æ™‚é–“è»¸ -->
                <div class="space-y-6">
                    ${(dayPlan.events || []).map((event, index) => `
                        <div class="timeline-item ${event.type === 'highlight' ? 'timeline-highlight' : ''} group">
                            <div class="ml-4 flex justify-between items-start">
                                <div class="flex-grow">
                                    <p class="text-xs text-gray-500 font-mono">${event.time}</p>
                                    <p class="text-base font-semibold text-gray-800 flex items-center">
                                        <i class="${getIconForEventType(event.type)} mr-2 text-sm"></i>
                                        ${event.name}
                                    </p>
                                    ${event.location ? `
                                        <div class="mt-2 space-x-2">
                                            <!-- é»æ“Šå¾Œé–‹å•Ÿ Modal æç¤ºï¼Œå°å‘åœ°åœ– App -->
                                            <button onclick="showMapModal('${event.location}', 'è¡Œç¨‹åœ°é»: ${event.name}')" class="text-xs inline-flex items-center px-2 py-1 primary-bg text-white rounded-full transition duration-300 hover:opacity-80">
                                                <i class="fa-solid fa-map-marker-alt mr-1"></i> Google Maps (å°èˆª)
                                            </button>
                                            ${event.type === 'food' ? `
                                                <a href="https://www.google.com/search?q=${encodeURIComponent(event.name + ' é£Ÿè¨˜ æ¨è–¦')}" target="_blank" class="text-xs inline-flex items-center px-2 py-1 secondary-bg text-white rounded-full transition duration-300 hover:opacity-80">
                                                    <i class="fa-solid fa-book-open mr-1"></i> æŸ¥çœ‹é£Ÿè¨˜
                                                </a>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="flex-shrink-0 ml-4 flex space-x-2 opacity-0 group-hover:opacity-100 transition duration-300">
                                    <button onclick="showEditEventModal('${dayPlan.docId}', ${index})" class="text-gray-500 hover:text-blue-600 p-1"><i class="fa-solid fa-pencil-alt text-xs"></i></button>
                                    <button onclick="confirmDeleteEvent('${dayPlan.docId}', ${index}, '${event.name}')" class="text-gray-500 hover:text-red-600 p-1"><i class="fa-solid fa-times text-xs"></i></button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    <div class="text-center pt-4">
                        <button onclick="showAddEventModal('${dayPlan.docId}')" class="text-sm secondary-text hover:underline">
                            <i class="fa-solid fa-plus-circle mr-1"></i> æ–°å¢æ´»å‹•
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        container.innerHTML = listHtml;
    }

    // Helper: ç²å–æ´»å‹•åœ–æ¨™
    function getIconForEventType(type) {
        switch (type) {
            case 'food': return 'fa-solid fa-utensils text-green-600';
            case 'sight': return 'fa-solid fa-camera-retro text-yellow-600';
            case 'highlight': return 'fa-solid fa-star primary-text';
            case 'info': return 'fa-solid fa-plane-departure text-blue-600';
            case 'activity': return 'fa-solid fa-shopping-bag text-purple-600';
            default: return 'fa-solid fa-map-marker-alt text-gray-500';
        }
    }

    // ================= PLAN - Firestore å¯«å…¥/ä¿®æ”¹é‚è¼¯ (CRUD Functions) =================

    async function addDayToFirestore(day, date, order) {
        const itineraryRef = getItineraryCollectionRef();
        if (!itineraryRef) return;

        showLoading('æ­£åœ¨æ–°å¢è¡Œç¨‹æ—¥...');

        try {
            const newDay = {
                day: day,
                date: date,
                order: parseInt(order),
                events: []
            };
            // ä½¿ç”¨ addDoc è®“ Firestore è‡ªå‹•ç”Ÿæˆ Doc ID
            await firebaseModules.addDoc(itineraryRef, newDay);
            alertMessage('è¡Œç¨‹æ—¥æ–°å¢æˆåŠŸï¼', 'primary-bg');
        } catch (e) {
            console.error("Error adding document:", e);
            alertMessage('æ–°å¢å¤±æ•—ï¼è«‹æª¢æŸ¥é€£ç·šæˆ– Firestore è¦å‰‡ã€‚', 'secondary-bg');
        } finally {
            hideLoading();
        }
    }

    async function updateDayInFirestore(docId, day, date, order) {
        const itineraryRef = getItineraryCollectionRef();
        if (!itineraryRef) return;

        showLoading('æ­£åœ¨æ›´æ–°è¡Œç¨‹æ—¥è³‡è¨Š...');

        try {
            const dayRef = firebaseModules.doc(itineraryRef, docId);
            await firebaseModules.updateDoc(dayRef, {
                day: day,
                date: date,
                order: parseInt(order)
            });
            alertMessage('è¡Œç¨‹æ—¥æ›´æ–°æˆåŠŸï¼', 'primary-bg');
        } catch (e) {
            console.error("Error updating document:", e);
            alertMessage('æ›´æ–°å¤±æ•—ï¼è«‹æª¢æŸ¥é€£ç·šæˆ– Firestore è¦å‰‡ã€‚', 'secondary-bg');
        } finally {
            hideLoading();
        }
    }

    async function deleteDayFromFirestore(docId) {
        const itineraryRef = getItineraryCollectionRef();
        if (!itineraryRef) return;

        showLoading('æ­£åœ¨åˆªé™¤è¡Œç¨‹æ—¥...');

        try {
            const dayRef = firebaseModules.doc(itineraryRef, docId);
            await firebaseModules.deleteDoc(dayRef);
            alertMessage('è¡Œç¨‹æ—¥åˆªé™¤æˆåŠŸï¼', 'primary-bg');
        } catch (e) {
            console.error("Error deleting document:", e);
            alertMessage('åˆªé™¤å¤±æ•—ï¼è«‹æª¢æŸ¥é€£ç·šæˆ– Firestore è¦å‰‡ã€‚', 'secondary-bg');
        } finally {
            hideLoading();
        }
    }

    async function addEventToDay(docId, eventData) {
        const currentDay = cloudItineraryData.find(d => d.docId === docId);
        if (!currentDay) return;

        showLoading('æ­£åœ¨æ–°å¢æ´»å‹•...');
        const updatedEvents = [...(currentDay.events || []), eventData];
        updatedEvents.sort((a, b) => a.time.localeCompare(b.time)); // ä¾æ™‚é–“æ’åº

        try {
            await firebaseModules.updateDoc(firebaseModules.doc(getItineraryCollectionRef(), docId), {
                events: updatedEvents
            });
            alertMessage('æ´»å‹•æ–°å¢æˆåŠŸï¼', 'primary-bg');
        } catch (e) {
            console.error("Error adding event:", e);
            alertMessage('æ–°å¢å¤±æ•—ï¼è«‹æª¢æŸ¥é€£ç·šæˆ– Firestore è¦å‰‡ã€‚', 'secondary-bg');
        } finally {
            hideLoading();
        }
    }

    async function updateEventInDay(docId, eventIndex, eventData) {
        const currentDay = cloudItineraryData.find(d => d.docId === docId);
        if (!currentDay) return;

        showLoading('æ­£åœ¨æ›´æ–°æ´»å‹•...');
        const updatedEvents = [...(currentDay.events || [])];
        updatedEvents[eventIndex] = eventData;
        updatedEvents.sort((a, b) => a.time.localeCompare(b.time)); // ä¾æ™‚é–“æ’åº

        try {
            await firebaseModules.updateDoc(firebaseModules.doc(getItineraryCollectionRef(), docId), {
                events: updatedEvents
            });
            alertMessage('æ´»å‹•æ›´æ–°æˆåŠŸï¼', 'primary-bg');
        } catch (e) {
            console.error("Error updating event:", e);
            alertMessage('æ›´æ–°å¤±æ•—ï¼è«‹æª¢æŸ¥é€£ç·šæˆ– Firestore è¦å‰‡ã€‚', 'secondary-bg');
        } finally {
            hideLoading();
        }
    }

    async function deleteEventFromDay(docId, eventIndex) {
        const currentDay = cloudItineraryData.find(d => d.docId === docId);
        if (!currentDay) return;

        showLoading('æ­£åœ¨åˆªé™¤æ´»å‹•...');
        const updatedEvents = (currentDay.events || []).filter((_, index) => index !== eventIndex);

        try {
            await firebaseModules.updateDoc(firebaseModules.doc(getItineraryCollectionRef(), docId), {
                events: updatedEvents
            });
            alertMessage('æ´»å‹•åˆªé™¤æˆåŠŸï¼', 'primary-bg');
        } catch (e) {
            console.error("Error deleting event:", e);
            alertMessage('åˆªé™¤å¤±æ•—ï¼è«‹æª¢æŸ¥é€£ç·šæˆ– Firestore è¦å‰‡ã€‚', 'secondary-bg');
        } finally {
            hideLoading();
        }
    }


    // ================= PLAN - æ¨¡æ…‹æ¡† (Modal) é‚è¼¯ =================

    // æ³›ç”¨æ¨¡æ…‹æ¡† HTML çµæ§‹
    function createModal(id, title, bodyHtml, confirmText, onConfirm, cancelText = 'å–æ¶ˆ') {
        const existing = document.getElementById(id);
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.id = id;
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4 transition-opacity duration-300';
        modal.innerHTML = `
            <div class="bg-card w-full max-w-sm rounded-xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
                <h3 class="text-xl font-bold primary-text mb-4 border-b pb-2">${title}</h3>
                <div id="${id}-body">${bodyHtml}</div>
                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                    <button onclick="closeModal('${id}')" class="text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-100">${cancelText}</button>
                    <button id="${id}-confirm" class="primary-bg text-white px-4 py-2 rounded-lg font-bold hover:opacity-90">${confirmText}</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // è¨­ç½®ç¢ºèªæŒ‰éˆ•äº‹ä»¶
        document.getElementById(`${id}-confirm`).onclick = onConfirm;

        // é¡¯ç¤ºå‹•ç•«
        setTimeout(() => modal.classList.add('opacity-100'), 10);
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.remove(), 300);
        }
    }

    function showAddDayModal() {
        const lastDayOrder = cloudItineraryData.length > 0 ? Math.max(...cloudItineraryData.map(d => d.order)) : 0;
        const nextOrder = lastDayOrder + 1;
        const body = `
            <div class="space-y-3">
                <input type="text" id="modal-day-name" placeholder="ä¾‹å¦‚: D6 (è‡ªç”±æ´»å‹•)" class="w-full p-2 border rounded-md focus:ring primary-text">
                <input type="text" id="modal-day-date" placeholder="ä¾‹å¦‚: 03/12 (å››)" class="w-full p-2 border rounded-md focus:ring primary-text">
                <input type="number" id="modal-day-order" value="${nextOrder}" class="w-full p-2 border rounded-md focus:ring primary-text">
            </div>
        `;

        createModal('add-day-modal', 'æ–°å¢è¡Œç¨‹æ—¥', body, 'ç¢ºèªæ–°å¢', () => {
            const day = document.getElementById('modal-day-name').value;
            const date = document.getElementById('modal-day-date').value;
            const order = document.getElementById('modal-day-order').value;
            if (day && date && order) {
                addDayToFirestore(day, date, order);
                closeModal('add-day-modal');
            } else {
                alertMessage('è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼', 'secondary-bg');
            }
        });
    }

    function showEditDayModal(docId, currentDay, currentDate, currentOrder) {
        const body = `
            <div class="space-y-3">
                <label class="text-xs text-gray-500">è¡Œç¨‹æ—¥åç¨± (ä¾‹å¦‚: D1)</label>
                <input type="text" id="modal-day-name" value="${currentDay}" class="w-full p-2 border rounded-md focus:ring primary-text">
                <label class="text-xs text-gray-500">æ—¥æœŸ (ä¾‹å¦‚: 03/07 (å…­))</label>
                <input type="text" id="modal-day-date" value="${currentDate}" class="w-full p-2 border rounded-md focus:ring primary-text">
                <label class="text-xs text-gray-500">æ’åº (æ•¸å­—è¶Šå°è¶Šå‰é¢)</label>
                <input type="number" id="modal-day-order" value="${currentOrder}" class="w-full p-2 border rounded-md focus:ring primary-text">
            </div>
        `;

        createModal('edit-day-modal', 'ç·¨è¼¯è¡Œç¨‹æ—¥è³‡è¨Š', body, 'å„²å­˜è®Šæ›´', () => {
            const day = document.getElementById('modal-day-name').value;
            const date = document.getElementById('modal-day-date').value;
            const order = document.getElementById('modal-day-order').value;
            if (day && date && order) {
                updateDayInFirestore(docId, day, date, order);
                closeModal('edit-day-modal');
            } else {
                alertMessage('è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼', 'secondary-bg');
            }
        });
    }

    function confirmDeleteDay(docId, dayName) {
        const body = `<p>æ‚¨ç¢ºå®šè¦åˆªé™¤ **${dayName}** é€™ä¸€å¤©çš„æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>`;
        createModal('confirm-delete-day-modal', 'ç¢ºèªåˆªé™¤è¡Œç¨‹æ—¥', body, 'ç¢ºå®šåˆªé™¤', () => {
            deleteDayFromFirestore(docId);
            closeModal('confirm-delete-day-modal');
        }, 'å–æ¶ˆ');
    }

    function showAddEventModal(docId) {
        const body = `
            <form id="event-form" class="space-y-3">
                <input type="text" id="modal-event-time" placeholder="æ™‚é–“ (ä¾‹å¦‚: 10:30)" class="w-full p-2 border rounded-md focus:ring primary-text">
                <input type="text" id="modal-event-name" placeholder="æ´»å‹•åç¨± (ä¾‹å¦‚: åˆé¤/æ™¯é»åç¨±)" class="w-full p-2 border rounded-md focus:ring primary-text">
                <input type="text" id="modal-event-location" placeholder="åœ°é»åç¨± (ç”¨æ–¼ Google Maps é€£çµï¼Œå¯é¸)" class="w-full p-2 border rounded-md focus:ring primary-text">
                <select id="modal-event-type" class="w-full p-2 border rounded-md focus:ring primary-text">
                    <option value="activity">æ´»å‹•/è³¼ç‰© (activity)</option>
                    <option value="food">ç”¨é¤ (food)</option>
                    <option value="sight">æ™¯é» (sight)</option>
                    <option value="highlight">é‡è¦é›†åˆ/æé†’ (highlight)</option>
                    <option value="info">äº¤é€š/è³‡è¨Š (info)</option>
                </select>
            </form>
        `;

        createModal('add-event-modal', 'æ–°å¢æ´»å‹•', body, 'ç¢ºèªæ–°å¢', () => {
            const time = document.getElementById('modal-event-time').value;
            const name = document.getElementById('modal-event-name').value;
            const location = document.getElementById('modal-event-location').value;
            const type = document.getElementById('modal-event-type').value;

            if (time && name) {
                const eventData = { time, name, location: location || undefined, type };
                addEventToDay(docId, eventData);
                closeModal('add-event-modal');
            } else {
                alertMessage('æ™‚é–“å’Œæ´»å‹•åç¨±ç‚ºå¿…å¡«ï¼', 'secondary-bg');
            }
        });
    }

    function showEditEventModal(docId, eventIndex) {
        const currentDay = cloudItineraryData.find(d => d.docId === docId);
        const currentEvent = currentDay.events[eventIndex];

        const body = `
            <form id="event-form" class="space-y-3">
                <label class="text-xs text-gray-500">æ™‚é–“</label>
                <input type="text" id="modal-event-time" value="${currentEvent.time}" class="w-full p-2 border rounded-md focus:ring primary-text">
                <label class="text-xs text-gray-500">æ´»å‹•åç¨±</label>
                <input type="text" id="modal-event-name" value="${currentEvent.name}" class="w-full p-2 border rounded-md focus:ring primary-text">
                <label class="text-xs text-gray-500">åœ°é»åç¨± (Google Maps)</label>
                <input type="text" id="modal-event-location" value="${currentEvent.location || ''}" placeholder="å¯é¸" class="w-full p-2 border rounded-md focus:ring primary-text">
                <label class="text-xs text-gray-500">æ´»å‹•é¡å‹</label>
                <select id="modal-event-type" class="w-full p-2 border rounded-md focus:ring primary-text">
                    <option value="activity" ${currentEvent.type === 'activity' ? 'selected' : ''}>æ´»å‹•/è³¼ç‰© (activity)</option>
                    <option value="food" ${currentEvent.type === 'food' ? 'selected' : ''}>ç”¨é¤ (food)</option>
                    <option value="sight" ${currentEvent.type === 'sight' ? 'selected' : ''}>æ™¯é» (sight)</option>
                    <option value="highlight" ${currentEvent.type === 'highlight' ? 'selected' : ''}>é‡è¦é›†åˆ/æé†’ (highlight)</option>
                    <option value="info" ${currentEvent.type === 'info' ? 'selected' : ''}>äº¤é€š/è³‡è¨Š (info)</option>
                </select>
            </form>
        `;

        createModal('edit-event-modal', 'ç·¨è¼¯æ´»å‹•', body, 'å„²å­˜è®Šæ›´', () => {
            const time = document.getElementById('modal-event-time').value;
            const name = document.getElementById('modal-event-name').value;
            const location = document.getElementById('modal-event-location').value;
            const type = document.getElementById('modal-event-type').value;

            if (time && name) {
                const eventData = { time, name, location: location || undefined, type };
                updateEventInDay(docId, eventIndex, eventData);
                closeModal('edit-event-modal');
            } else {
                alertMessage('æ™‚é–“å’Œæ´»å‹•åç¨±ç‚ºå¿…å¡«ï¼', 'secondary-bg');
            }
        });
    }

    function confirmDeleteEvent(docId, eventIndex, eventName) {
        const body = `<p>æ‚¨ç¢ºå®šè¦åˆªé™¤ **${eventName}** é€™å€‹æ´»å‹•å—ï¼Ÿ</p>`;
        createModal('confirm-delete-event-modal', 'ç¢ºèªåˆªé™¤æ´»å‹•', body, 'ç¢ºå®šåˆªé™¤', () => {
            deleteEventFromDay(docId, eventIndex);
            closeModal('confirm-delete-event-modal');
        }, 'å–æ¶ˆ');
    }

    // ====================================================================
    // 5. GUIDE (æ·±åº¦å°è¦½) æ¸²æŸ“å‡½æ•¸ - å·²æ›´æ–°åœ–ç‰‡/åœ°åœ–é‚è¼¯
    // ====================================================================
    
    // Helper: ç²å–åœ°é» Emoji
    function getLocationEmoji(name) {
        if (name.includes('åœ‹éš›é€š')) return 'ğŸ›ï¸';
        if (name.includes('æ³¢ä¸Šå®®')) return 'â›©ï¸';
        if (name.includes('é¦–é‡ŒåŸ')) return 'ğŸ¯';
        if (name.includes('Outlet') || name.includes('DFS')) return 'ğŸ‘œ';
        if (name.includes('å£ºå±‹')) return 'ğŸº';
        if (name.includes('ç€¨é•·å³¶')) return 'ğŸ–ï¸';
        if (name.includes('ç‰§å¿—å…¬è¨­å¸‚å ´')) return 'ğŸŸ';
        if (name.includes('ç¦å·åœ’')) return 'ğŸŒ³';
        if (name.includes('DMM')) return 'ğŸ ';
        return 'ğŸ“';
    }


    function renderGuide(container) {
        // [ä¿®æ­£] åœ–ç‰‡å·²æ›¿æ›ç‚º Emoji + Cardï¼Œä¸¦æ–°å¢ç‡Ÿæ¥­æ™‚é–“å’Œ Google Maps é€£çµã€‚
        const topSpots = [
            { name: "åœ‹éš›é€š (Kokusai Street)", desc: "é‚£éœ¸å¸‚æœ€ç†±é¬§çš„è¡—é“ï¼Œé•·ç´„ 1.6 å…¬é‡Œï¼Œæœ‰ã€Œå¥‡è¹Ÿçš„ä¸€è‹±é‡Œã€ä¹‹ç¨±ï¼Œè³¼ç‰©å’Œç¾é£Ÿèšé›†åœ°ã€‚", mapLocation: "æ²–ç¹©åœ‹éš›é€š", hours: "å…¨å¤©é–‹æ”¾ï¼Œåº—å®¶ç´„ 10:00 - 22:00", type: 'sight' },
            { name: "æ³¢ä¸Šå®® (Naminoue Shrine)", desc: "å»ºæ–¼æ‡¸å´–ä¸Šçš„ç¥ç¤¾ï¼Œé¢å‘å¤§æµ·ï¼Œæ˜¯ç‰çƒå…«ç¤¾ä¹‹é¦–ï¼Œå¯æ­¥è¡Œæˆ–æ­ä¹˜å–®è»Œé›»è»Šè‡³ç¸£å»³å‰ç«™ã€‚", mapLocation: "æ³¢ä¸Šå®®", hours: "09:00 - 17:00 (ç¥ç¤¾åƒæ‹œæ™‚é–“)", type: 'sight' },
            { name: "é¦–é‡ŒåŸå…¬åœ’ (Shurijo Castle)", desc: "ç‰çƒç‹åœ‹çš„æ”¿æ²»ã€æ–‡åŒ–ä¸­å¿ƒï¼Œèåˆä¸­æ—¥å»ºç¯‰é¢¨æ ¼ã€‚æ­ä¹˜å–®è»Œé›»è»Šè‡³é¦–é‡Œç«™å¾Œæ­¥è¡Œæˆ–è½‰ä¹˜å·´å£«ã€‚", mapLocation: "é¦–é‡ŒåŸ", hours: "08:30 - 18:00 (ä¾å­£ç¯€è®Šå‹•)", type: 'sight' },
            { name: "æ²–ç¹© Outlet Mall Ashibinaa", desc: "é‚£éœ¸å¸‚å€é™„è¿‘çš„å¤§å‹æš¢è²¨ä¸­å¿ƒï¼Œé è¿‘é‚£éœ¸æ©Ÿå ´ï¼Œæœ‰å·´å£«ç›´é”ï¼Œéå¸¸é©åˆå›ç¨‹å‰è³¼ç‰©ã€‚", mapLocation: "æ²–ç¹© Outlet Mall Ashibinaa", hours: "10:00 - 20:00", type: 'activity' },
            { name: "T Galleria Okinawa (DFS å…ç¨…åº—)", desc: "ä½æ–¼ Omoromachi ç«™ï¼Œæ˜¯äºæ´²æœ€å¤§çš„è·¯é¢å…ç¨…åº—ä¹‹ä¸€ï¼Œå¯åœ¨å›åœ‹å‰è³¼è²·å…ç¨…ç²¾å“ã€‚", mapLocation: "T Galleria Okinawa", hours: "10:00 - 20:00", type: 'activity' },
            { name: "å£ºå±‹ç‡’ç‰©åšç‰©é¤¨ (Tsuboya Pottery Museum)", desc: "å±•ç¤ºæ²–ç¹©å‚³çµ±é™¶å™¨ã€Œå£ºå±‹ç‡’ã€çš„æ­·å²å’ŒæŠ€è—ï¼Œä½æ–¼å……æ»¿å¤æ¨¸æ°£æ¯çš„å£ºå±‹é€šå…§ã€‚", mapLocation: "å£ºå±‹ç‡’ç‰©åšç‰©é¤¨", hours: "10:00 - 18:00 (é€±ä¸€ä¼‘é¤¨)", type: 'sight' },
            { name: "ç€¨é•·å³¶ Umikaji Terrace", desc: "ä½æ–¼æ©Ÿå ´é™„è¿‘çš„å°å³¶ï¼Œæ“æœ‰æµ·æ™¯æº«æ³‰å’Œç™½è‰²åœ°ä¸­æµ·é¢¨æ ¼çš„è³¼ç‰©é¤é£²å€ï¼Œé©åˆæ‹ç…§å’Œçœ‹é£›æ©Ÿèµ·é™ã€‚", mapLocation: "ç€¬é•·å³¶ã‚¦ãƒŸã‚«ã‚¸ãƒ†ãƒ©ã‚¹", hours: "10:00 - 21:00 (ä¾åº—å®¶è€Œç•°)", type: 'sight' },
            { name: "ç‰§å¿—å…¬è¨­å¸‚å ´ (Makishi Public Market)", desc: "è¢«è­½ç‚ºã€Œæ²–ç¹©çš„å»šæˆ¿ã€ï¼Œå¯ä»¥è³¼è²·æ–°é®®æµ·ç”¢å¾Œè«‹åº—å®¶ä»£å®¢æ–™ç†ï¼Œé«”é©—åœ¨åœ°ç¾é£Ÿæ–‡åŒ–ã€‚", mapLocation: "é‚£éœ¸å¸‚ç¬¬ä¸€ç‰§å¿—å…¬è¨­å¸‚å ´", hours: "08:00 - 22:00 (æ¯æœˆéƒ¨åˆ†é€±æ—¥ä¼‘å¸‚)", type: 'food' },
            { name: "ç¦å·åœ’ (Fukushu Garden)", desc: "é‚£éœ¸å¸‚å€çš„ä¸­åœ‹å¼åº­åœ’ï¼Œæ™¯è‡´å„ªç¾ï¼Œé©åˆæ¼«æ­¥ä¼‘æ†©ï¼Œäº¤é€šä¾¿åˆ©ã€‚", mapLocation: "ç¦å·åœ’", hours: "09:00 - 21:00", type: 'sight' },
            { name: "DMM Kariyushiæ°´æ—é¤¨", desc: "é‚£éœ¸å¸‚å—éƒ¨çš„ç¾ä»£åŒ–æ°´æ—é¤¨ï¼Œå¼·èª¿å…‰å½±èˆ‡ç§‘æŠ€çµåˆï¼Œèˆ‡ç¾éº—æµ·æ°´æ—é¤¨é¢¨æ ¼ä¸åŒï¼Œé‚£éœ¸å¸‚å€æœ‰å…¬è»Šå¯é”ã€‚", mapLocation: "DMM Kariyushiæ°´æ—é¤¨", hours: "10:00 - 21:00 (ä¾å­£ç¯€è®Šå‹•)", type: 'sight' }
        ];

        const topFoods = [
            { name: "æ²–ç¹©éºµ (Okinawa Soba)", brief: "ä½¿ç”¨å°éº¥ç²‰è£½æˆï¼Œå£æ„ŸQå½ˆï¼Œæ¹¯é ­æ¸…æ·¡ï¼Œæ­é…ç‡‰ç…®çš„è‚‰å¡Šã€‚", mapLocation: "æ²–ç¹©ãã°å°‚é–€åº—", hours: "ä¾åº—å®¶è€Œç•°", type: 'food' },
            { name: "å¡”å¯é£¯ (Taco Rice)", brief: "ç±³é£¯ä¸Šé‹ªæ»¿ç¾å¢¨å¼å¡”å¯è‚‰é†¬ã€èµ·å¸ã€ç”Ÿèœå’Œç•ªèŒ„ï¼Œæ²–ç¹©ç‰¹æœ‰æ··æ­ç¾é£Ÿã€‚", mapLocation: "ã‚¿ã‚³ãƒ©ã‚¤ã‚¹åº—", hours: "ä¾åº—å®¶è€Œç•°", type: 'food' },
            { name: "é˜¿å¤è±¬ (Aguu Pork)", brief: "æ²–ç¹©ç‰¹æœ‰çš„é»‘è±¬å“ç¨®ï¼Œè„‚è‚ªèé»ä½ã€è‚‰è³ªé®®ç”œï¼Œé©åˆæ¶®æ¶®é‹æˆ–çƒ¤è‚‰ã€‚", mapLocation: "ã‚¢ã‚°ãƒ¼è±šæ–™ç†åº—", hours: "ä¾åº—å®¶è€Œç•°", type: 'food' },
            { name: "æµ·è‘¡è„ (Umi-Budo)", brief: "ä¸€ç¨®æµ·è—»ï¼Œå¤–è§€åƒä¸€ä¸²ä¸²ç¶ è‰²å°è‘¡è„ï¼Œå£æ„Ÿé¹¹è„†çˆ†ç ´ï¼Œå¸¸ä½œç‚ºä¸‹é…’èœæˆ–æ²™æ‹‰ã€‚", mapLocation: "æµ·ã¶ã©ã†å°‚é–€", hours: "ä¾åº—å®¶è€Œç•°", type: 'food' },
            { name: "æ²–ç¹©ç´…èŠ‹å¡”", brief: "ä½¿ç”¨æ²–ç¹©ç‰¹ç”¢ç´…èŠ‹è£½ä½œçš„ç”œé»ï¼Œé¦™ç”œå¯å£ï¼Œæ˜¯ç¶“å…¸çš„ä¼´æ‰‹ç¦®ã€‚", mapLocation: "ç´…ã„ã‚‚ã‚¿ãƒ«ãƒˆåº—", hours: "ä¾åº—å®¶è€Œç•°", type: 'food' },
            { name: "Blue Seal å†°æ·‡æ·‹", brief: "æºè‡ªç¾åœ‹ä¸¦ç´®æ ¹æ²–ç¹©çš„å†°æ·‡æ·‹å“ç‰Œï¼Œå£å‘³é¸æ“‡å¤šæ¨£ï¼Œæ˜¯æµ·å³¶æ¶ˆæš‘è–å“ã€‚", mapLocation: "Blue Seal å†°æ·‡æ·‹", hours: "ä¾åˆ†åº—è€Œç•°", type: 'food' },
            { name: "çŸ³å£ç‰›/å®®å¤ç‰›", brief: "æ²–ç¹©é›¢å³¶çš„é ‚ç´šå’Œç‰›ï¼Œè‚‰è³ªç´°å«©ï¼Œåœ¨æ²–ç¹©æœ¬å³¶ä¹Ÿèƒ½æ‰¾åˆ°å°ˆè³£åº—ã€‚", mapLocation: "çŸ³å£ç‰›ç„¼è‚‰åº—", hours: "ä¾åº—å®¶è€Œç•°", type: 'food' },
            { name: "è‹¦ç“œç‚’è›‹ (Goya Chanpuru)", brief: "æ²–ç¹©ä»£è¡¨æ€§å®¶åº­æ–™ç†ï¼Œè‹¦ç“œã€é›è›‹ã€è±†è…å’Œåˆé¤è‚‰ä¸€èµ·ç¿»ç‚’ï¼Œæ¸…çˆ½è§£è†©ã€‚", mapLocation: "ã‚´ãƒ¼ãƒ¤ãƒãƒ£ãƒ³ãƒ—ãƒ«ãƒ¼åº—", hours: "ä¾åº—å®¶è€Œç•°", type: 'food' },
            { name: "ä»£å®¢æ–™ç†æµ·é®®", brief: "åœ¨ç‰§å¿—å¸‚å ´è³¼è²·æ–°é®®é­šè¦ï¼Œç›´æ¥è«‹äºŒæ¨“åº—å®¶çƒ¹ç…®ï¼Œæ–°é®®åº¦ç„¡å¯åŒ¹æ•µã€‚", mapLocation: "é‚£è¦‡å¸‚ç¬¬ä¸€ç‰§å¿—å…¬è¨­å¸‚å ´", hours: "ä¾åº—å®¶è€Œç•°", type: 'food' },
            { name: "èŠ±ç”Ÿè±†è… (Jimami Tofu)", brief: "ä½¿ç”¨èŠ±ç”Ÿè£½æˆçš„è±†è…ï¼Œå£æ„Ÿè»Ÿç³¯æ»‘é †ï¼Œå¸¸æ­é…ç”œé†¬æ²¹é£Ÿç”¨ï¼Œæ˜¯ç¨ç‰¹çš„ç”œé»/é–‹èƒƒèœã€‚", mapLocation: "ã‚¸ãƒ¼ãƒãƒ¼ãƒŸè±†è…åº—", hours: "ä¾åº—å®¶è€Œç•°", type: 'food' }
        ];

        const content = `
            <div class="space-y-8">
                <!-- æ²–ç¹© TOP 10 æ™¯é» (é‚£éœ¸ç‚ºä¸») -->
                <div class="bg-card p-6 rounded-xl shadow-lg border-l-4 border-primary">
                    <h2 class="text-2xl font-bold primary-text mb-4 flex items-center"><i class="fa-solid fa-map-location-dot mr-2"></i> æ²–ç¹© TOP 10 äº¤é€šä¾¿åˆ©æ™¯é»</h2>
                    <p class="text-sm text-gray-500 mb-6">ä»¥é‚£éœ¸å¸‚å€ç‚ºä¸­å¿ƒï¼Œæ­ä¹˜å–®è»Œé›»è»Šæˆ–æ­¥è¡Œå¯é”çš„ç²¾é¸æ™¯é»ã€‚</p>
                    <div class="space-y-6">
                        ${topSpots.map((spot, index) => `
                            <div class="flex border-b pb-4 last:border-b-0 last:pb-0">
                                <!-- åœ–ç‰‡å·²æ›´æ›ç‚º Emoji + Card -->
                                <div class="w-24 h-20 bg-secondary/20 rounded-lg mr-4 flex-shrink-0 shadow-md flex flex-col items-center justify-center">
                                    <span class="text-2xl">${getLocationEmoji(spot.name)}</span>
                                    <span class="text-xs font-medium mt-1 text-gray-700">${spot.name.split(' ')[0]}</span>
                                </div>
                                <div class="flex-grow">
                                    <h3 class="font-bold secondary-text text-lg">${index + 1}. ${spot.name}</h3>
                                    <p class="text-sm text-gray-600 mt-1">${spot.desc}</p>
                                    <p class="text-xs text-gray-500 mt-1"><i class="fa-regular fa-clock mr-1"></i> **ç‡Ÿæ¥­æ™‚é–“:** ${spot.hours}</p>
                                    <div class="mt-2">
                                        <!-- é»æ“Šå¾Œé–‹å•Ÿ Modal æç¤ºï¼Œå°å‘åœ°åœ– App -->
                                        <button onclick="showMapModal('${spot.mapLocation}', '${spot.name}')" class="text-xs inline-flex items-center px-2 py-1 primary-bg text-white rounded-full transition duration-300 hover:opacity-80">
                                            <i class="fa-solid fa-map-marker-alt mr-1"></i> Google åœ°åœ– (å°èˆª)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- æ²–ç¹© TOP 10 ç¾é£Ÿ -->
                 <div class="bg-card p-6 rounded-xl shadow-lg border-l-4 border-secondary">
                    <h2 class="text-2xl font-bold secondary-text mb-4 flex items-center"><i class="fa-solid fa-bowl-food mr-2"></i> æ²–ç¹© TOP 10 å¿…åšç¾é£Ÿ</h2>
                    <p class="text-sm text-gray-500 mb-6">çµ•ä¸èƒ½éŒ¯éçš„ç•¶åœ°ç‰¹è‰²æ–™ç†å’ŒçŸ¥åå°åƒã€‚</p>
                     <div class="space-y-6">
                        ${topFoods.map((food, index) => `
                            <div class="flex border-b pb-4 last:border-b-0 last:pb-0">
                                <!-- åœ–ç‰‡å·²æ›´æ›ç‚º Emoji + Card -->
                                <div class="w-24 h-20 bg-primary/20 rounded-lg mr-4 flex-shrink-0 shadow-md flex flex-col items-center justify-center">
                                    <span class="text-2xl">${food.emoji}</span>
                                    <span class="text-xs font-medium mt-1 text-gray-700">${food.name.split(' ')[0]}</span>
                                </div>
                                <div class="flex-grow">
                                    <h3 class="font-bold primary-text text-lg">${index + 1}. ${food.name}</h3>
                                    <p class="text-sm text-gray-600 mt-1">${food.brief}</p>
                                    <p class="text-xs text-gray-500 mt-1"><i class="fa-regular fa-clock mr-1"></i> **ç‡Ÿæ¥­æ™‚é–“:** ${food.hours}</p>
                                    <!-- é»æ“Šå¾Œé–‹å•Ÿ Modal æç¤ºï¼Œå°å‘åœ°åœ– App -->
                                    <button onclick="showMapModal('${food.mapLocation}', '${food.name}')" class="text-xs inline-flex items-center px-2 py-1 primary-bg text-white rounded-full mt-2 transition duration-300 hover:opacity-80">
                                        <i class="fa-solid fa-map-marker-alt mr-1"></i> Google åœ°åœ– (å°èˆª)
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = content;
    }


    // ====================================================================
    // 6. WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡) æ¸²æŸ“èˆ‡é‚è¼¯ (ç¶­æŒ LocalStorage)
    // ====================================================================

    let currentExchangeRate = initialRate;

    function renderWallet(container) {
        currentExchangeRate = parseFloat(localStorage.getItem(TWD_RATE_KEY)) || initialRate;

        const html = `
            <div class="space-y-6">
                <div class="p-4 bg-white rounded-xl shadow-md border-l-4 border-yellow-400 text-sm text-gray-700 font-medium">
                    <i class="fa-solid fa-user-lock mr-2 text-yellow-500"></i> **è¨˜å¸³è³‡æ–™åƒ…å„²å­˜åœ¨æœ¬æ©Ÿ**ï¼Œä¸èˆ‡é›²ç«¯åŒæ­¥ã€‚
                </div>
                <!-- åŒ¯ç‡æ›ç®—å™¨ -->
                <div class="bg-card p-5 rounded-xl shadow-lg border-l-4 border-yellow-400">
                    <h2 class="text-xl font-bold secondary-text mb-3 flex items-center"><i class="fa-solid fa-calculator mr-2"></i> å³æ™‚åŒ¯ç‡æ›ç®—</h2>
                    <div class="flex items-center justify-between mb-3 text-sm">
                        <span class="text-gray-600">ç•¶å‰åŒ¯ç‡ (1 JPY â‰ˆ TWD):</span>
                        <div class="flex items-center">
                            <input type="number" step="0.001" id="rate-input" value="${currentExchangeRate.toFixed(4)}" class="w-20 text-right p-1 border rounded-md text-gray-700 focus:ring primary-text">
                            <button onclick="updateExchangeRate()" class="ml-2 secondary-bg text-white px-2 py-1 rounded-md text-xs hover:opacity-90">æ›´æ–°</button>
                        </div>
                    </div>
                    <input type="text" id="calc-input" placeholder="è¼¸å…¥ç®—å¼ (ä¾‹å¦‚: 500+200*3)" class="w-full text-2xl font-mono p-3 mb-3 border rounded-lg focus:ring primary-text text-right" onkeyup="if(event.key === 'Enter') performCalculation()">
                    <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                        <div>
                            <p class="text-xs text-gray-500">æ—¥å¹£ (JPY) ç¸½é¡</p>
                            <p id="calc-jpy" class="text-xl font-bold text-gray-800">0</p>
                        </div>
                        <i class="fa-solid fa-arrows-right-left primary-text"></i>
                        <div>
                            <p class="text-xs text-gray-500 text-right">å°å¹£ (TWD) ä¼°ç®—</p>
                            <p id="calc-twd" class="text-xl font-bold primary-text text-right">0</p>
                        </div>
                    </div>
                    <button onclick="performCalculation()" class="w-full primary-bg text-white p-3 mt-3 rounded-lg font-bold shadow-md hover:opacity-90">æ›ç®— / è¨ˆç®— (=)</button>
                </div>

                <!-- è¨˜å¸³åŠŸèƒ½ -->
                <div class="bg-card p-5 rounded-xl shadow-lg border-l-4 border-primary">
                    <h2 class="text-xl font-bold primary-text mb-4 flex items-center"><i class="fa-solid fa-pen-to-square mr-2"></i> æ–°å¢è¨˜å¸³</h2>
                    <form id="expense-form" class="space-y-3">
                        <div>
                            <label for="item-name" class="text-sm font-medium text-gray-700">å“é …åç¨±</label>
                            <input type="text" id="item-name" placeholder="æ™šé¤/é–€ç¥¨/é›¶é£Ÿ..." required class="w-full p-2 border rounded-md focus:ring primary-text">
                        </div>
                        <div>
                            <label for="item-amount" class="text-sm font-medium text-gray-700">æ—¥å¹£é‡‘é¡ (JPY)</label>
                            <input type="number" id="item-amount" placeholder="5000" required class="w-full p-2 border rounded-md focus:ring primary-text">
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="photo-upload" class="primary-bg text-white px-4 py-2 rounded-lg font-medium cursor-pointer shadow-md hover:opacity-90 transition duration-150">
                                <i class="fa-solid fa-camera mr-2"></i> æ‹ç…§ / ä¸Šå‚³ç…§ç‰‡
                            </label>
                            <input type="file" id="photo-upload" accept="image/*" class="file-input-hidden" onchange="previewAndCompressImage(event)">
                            <img id="photo-preview" class="w-12 h-12 rounded-lg object-cover border hidden" alt="ç…§ç‰‡é è¦½">
                            <input type="hidden" id="base64-image" value="">
                        </div>
                        <button type="submit" class="w-full secondary-bg text-white p-3 rounded-lg font-bold shadow-md hover:opacity-90">è¨˜éŒ„æ¶ˆè²»</button>
                    </form>
                </div>

                <!-- è¨˜å¸³æ­·å²åˆ—è¡¨ -->
                <div class="mt-8">
                    <h2 class="text-xl font-bold primary-text mb-3 flex items-center"><i class="fa-solid fa-list-ul mr-2"></i> è¨˜å¸³æ­·å²</h2>
                    <div id="expense-list" class="space-y-3">
                        <!-- æ­·å²è¨˜éŒ„æœƒåœ¨æ­¤è™•æ¸²æŸ“ -->
                    </div>
                    <div id="expense-summary" class="mt-4 p-4 bg-white rounded-xl shadow-lg text-center font-bold">
                        <p class="text-gray-700">ç¸½è¨ˆï¼š<span class="text-lg primary-text" id="total-jpy">0 JPY</span> (<span class="text-lg secondary-text" id="total-twd">0 TWD</span>)</p>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = html;

        document.getElementById('expense-form').onsubmit = addExpense;
        loadExpenses();
    }

    // [WALLET ç›¸é—œçš„ JS å‡½æ•¸ (updateExchangeRate, performCalculation, safeEval, previewAndCompressImage, addExpense, loadExpenses, deleteExpense)]
    function updateExchangeRate() { /* ... */
        const input = document.getElementById('rate-input');
        const newRate = parseFloat(input.value);
        if (newRate > 0) {
            currentExchangeRate = newRate;
            localStorage.setItem(TWD_RATE_KEY, newRate.toString());
            performCalculation();
            alertMessage('åŒ¯ç‡æ›´æ–°æˆåŠŸï¼', 'primary-bg');
        } else {
            alertMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡ï¼', 'secondary-bg');
        }
    }

    function performCalculation() { /* ... */
        const input = document.getElementById('calc-input');
        const jpyDisplay = document.getElementById('calc-jpy');
        const twdDisplay = document.getElementById('calc-twd');
        const expression = input.value.trim();

        if (!expression) {
            jpyDisplay.textContent = '0';
            twdDisplay.textContent = '0';
            return;
        }

        try {
            const resultJPY = safeEval(expression);
            if (typeof resultJPY === 'number' && isFinite(resultJPY)) {
                const resultTWD = resultJPY * currentExchangeRate;
                jpyDisplay.textContent = resultJPY.toFixed(0).toLocaleString('en-US');
                twdDisplay.textContent = resultTWD.toFixed(0).toLocaleString('en-US');
            } else {
                jpyDisplay.textContent = 'éŒ¯èª¤';
                twdDisplay.textContent = 'éŒ¯èª¤';
            }
        } catch (e) {
            jpyDisplay.textContent = 'ç„¡æ•ˆç®—å¼';
            twdDisplay.textContent = '0';
        }
    }

    function safeEval(expression) { /* ... */
        const safeExpression = expression.replace(/[^-()\d/*+. ]/g, '');
        return new Function('return ' + safeExpression)();
    }

    function previewAndCompressImage(event) { /* ... */
        const file = event.target.files[0];
        const preview = document.getElementById('photo-preview');
        const base64Input = document.getElementById('base64-image');

        if (!file) {
            preview.classList.add('hidden');
            base64Input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 200;
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.6);

                preview.src = compressedBase64;
                preview.classList.remove('hidden');
                base64Input.value = compressedBase64;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function addExpense(e) { /* ... */
        e.preventDefault();

        const nameInput = document.getElementById('item-name');
        const amountInput = document.getElementById('item-amount');
        const base64Image = document.getElementById('base64-image');

        const expense = {
            id: crypto.randomUUID(),
            name: nameInput.value,
            jpy: parseFloat(amountInput.value),
            image: base64Image.value,
            date: new Date().toISOString()
        };

        if (isNaN(expense.jpy) || expense.jpy <= 0) {
            alertMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥å¹£é‡‘é¡ï¼', 'secondary-bg');
            return;
        }

        const expenses = loadData(LS_KEYS.WALLET, []);
        expenses.unshift(expense);
        saveData(LS_KEYS.WALLET, expenses);

        e.target.reset();
        document.getElementById('photo-preview').classList.add('hidden');
        base64Image.value = '';

        loadExpenses();
        alertMessage('æ¶ˆè²»è¨˜éŒ„æˆåŠŸï¼', 'primary-bg');
    }

    function loadExpenses() { /* ... */
        const expenses = loadData(LS_KEYS.WALLET, []);
        const listContainer = document.getElementById('expense-list');
        const totalJPYDisplay = document.getElementById('total-jpy');
        const totalTWDDisplay = document.getElementById('total-twd');

        if (!listContainer || !totalJPYDisplay) return;

        let totalJPY = 0;
        const rate = parseFloat(localStorage.getItem(TWD_RATE_KEY)) || initialRate;

        if (expenses.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-gray-500 p-4">ç›®å‰æ²’æœ‰è¨˜å¸³è¨˜éŒ„ã€‚</p>';
        } else {
            listContainer.innerHTML = expenses.map(item => {
                totalJPY += item.jpy;
                const twd = item.jpy * rate;
                return `
                    <div class="flex items-center p-3 bg-white rounded-lg shadow-md hover:shadow-lg transition duration-150">
                        ${item.image ? `
                            <img src="${item.image}" alt="æ”¶æ“š" class="w-12 h-12 object-cover rounded-md mr-3 flex-shrink-0">
                        ` : `
                            <div class="w-12 h-12 bg-gray-200 rounded-md mr-3 flex-shrink-0 flex items-center justify-center text-gray-500"><i class="fa-solid fa-image"></i></div>
                        `}
                        <div class="flex-grow min-w-0">
                            <p class="font-medium text-gray-800 truncate">${item.name}</p>
                            <p class="text-xs text-gray-500">${new Date(item.date).toLocaleDateString('zh-TW')} ${new Date(item.date).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</p>
                        </div>
                        <div class="text-right ml-4 flex-shrink-0">
                            <p class="font-bold primary-text">${item.jpy.toFixed(0).toLocaleString('en-US')} JPY</p>
                            <p class="text-xs text-gray-500">${twd.toFixed(0).toLocaleString('en-US')} TWD</p>
                        </div>
                        <button onclick="deleteExpense('${item.id}')" class="ml-2 text-red-400 hover:text-red-600 transition duration-150 p-1">
                            <i class="fa-solid fa-trash-alt text-sm"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        totalJPYDisplay.textContent = totalJPY.toFixed(0).toLocaleString('en-US') + ' JPY';
        totalTWDDisplay.textContent = (totalJPY * rate).toFixed(0).toLocaleString('en-US') + ' TWD';
    }

    function deleteExpense(id) { /* ... */
        let expenses = loadData(LS_KEYS.WALLET, []);
        const initialLength = expenses.length;
        expenses = expenses.filter(item => item.id !== id);

        if (expenses.length < initialLength) {
            saveData(LS_KEYS.WALLET, expenses);
            loadExpenses();
            alertMessage('åˆªé™¤æˆåŠŸï¼', 'primary-bg');
        }
    }


    // ====================================================================
    // 7. LISTS (æ¸…å–®èˆ‡å‚™å¿˜éŒ„) æ¸²æŸ“èˆ‡é‚è¼¯ (ç¶­æŒ LocalStorage)
    // ====================================================================

    function renderLists(container) {
        const html = `
            <div class="space-y-8">
                <div class="p-4 bg-white rounded-xl shadow-md border-l-4 border-primary/50 text-sm text-gray-700 font-medium">
                    <i class="fa-solid fa-user-lock mr-2 text-primary"></i> **æ¸…å–®èˆ‡å‚™å¿˜éŒ„** åƒ…å„²å­˜åœ¨æœ¬æ©Ÿã€‚
                </div>
                <!-- è¡Œå‰æº–å‚™æ¸…å–® (CheckList) -->
                <div class="bg-card p-5 rounded-xl shadow-lg border-l-4 border-primary">
                    <h2 class="text-xl font-bold primary-text mb-3 flex items-center"><i class="fa-solid fa-check-double mr-2"></i> è¡Œå‰æº–å‚™ CheckList</h2>
                    <div id="checklist-container" class="space-y-2">
                        <!-- æ¸…å–®é …ç›®æœƒåœ¨æ­¤è™•æ¸²æŸ“ -->
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-100 flex">
                        <input type="text" id="new-check-item" placeholder="æ–°å¢è‡ªè¨‚é …ç›®..." class="flex-grow p-2 border rounded-l-md focus:ring text-gray-700">
                        <button onclick="addChecklistItem()" class="primary-bg text-white px-3 py-2 rounded-r-md hover:opacity-90"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <!-- å€‹äººå‚™å¿˜éŒ„ (Memos) -->
                <div class="bg-card p-5 rounded-xl shadow-lg border-l-4 border-secondary">
                    <h2 class="text-xl font-bold secondary-text mb-3 flex items-center"><i class="fa-solid fa-note-sticky mr-2"></i> å€‹äººå‚™å¿˜éŒ„</h2>
                    <textarea id="memo-input" rows="3" placeholder="è¼¸å…¥æ‚¨çš„å‚™å¿˜éŒ„ï¼Œç¶²å€æœƒè‡ªå‹•è½‰æ›ç‚ºæŒ‰éˆ•..." class="w-full p-3 border rounded-md focus:ring text-gray-700"></textarea>
                    <button onclick="saveMemo()" class="w-full secondary-bg text-white p-2 mt-2 rounded-md font-bold shadow-md hover:opacity-90">å„²å­˜å‚™å¿˜</button>

                    <div id="memo-list" class="mt-4 pt-4 border-t border-gray-100 space-y-3">
                        <!-- å‚™å¿˜éŒ„åˆ—è¡¨æœƒåœ¨æ­¤è™•æ¸²æŸ“ -->
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = html;
        loadChecklist();
        loadMemos();
    }

    // [LISTS ç›¸é—œçš„ JS å‡½æ•¸ (loadChecklist, toggleChecklistItem, addChecklistItem, deleteChecklistItem, saveMemo, loadMemos)]
    function loadChecklist() { /* ... */
        const list = loadData(LS_KEYS.CHECKLIST, []);
        const container = document.getElementById('checklist-container');
        if (!container) return;

        container.innerHTML = list.map(item => `
            <div class="flex items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-150">
                <input type="checkbox" id="check-${item.id}" ${item.checked ? 'checked' : ''} onchange="toggleChecklistItem('${item.id}')" class="w-5 h-5 primary-text rounded-md border-gray-300 focus:ring-primary cursor-pointer">
                <label for="check-${item.id}" class="ml-3 text-base ${item.checked ? 'line-through text-gray-500' : 'text-gray-800'} flex-grow cursor-pointer">${item.text}</label>
                <button onclick="deleteChecklistItem('${item.id}')" class="text-red-400 hover:text-red-600 transition duration-150 p-1">
                    <i class="fa-solid fa-times text-sm"></i>
                </button>
            </div>
        `).join('');
    }

    function toggleChecklistItem(id) { /* ... */
        const list = loadData(LS_KEYS.CHECKLIST, []);
        const item = list.find(i => i.id === id);
        if (item) {
            item.checked = !item.checked;
            saveData(LS_KEYS.CHECKLIST, list);
            loadChecklist();
        }
    }

    function addChecklistItem() { /* ... */
        const input = document.getElementById('new-check-item');
        const text = input.value.trim();
        if (text) {
            const list = loadData(LS_KEYS.CHECKLIST, []);
            list.push({ id: crypto.randomUUID(), text, checked: false });
            saveData(LS_KEYS.CHECKLIST, list);
            input.value = '';
            loadChecklist();
        }
    }

    function deleteChecklistItem(id) { /* ... */
        let list = loadData(LS_KEYS.CHECKLIST, []);
        list = list.filter(item => item.id !== id);
        saveData(LS_KEYS.CHECKLIST, list);
        loadChecklist();
    }

    function saveMemo() { /* ... */
        const input = document.getElementById('memo-input');
        const text = input.value.trim();
        if (text) {
            saveData(LS_KEYS.MEMOS, [text]);
            input.value = text;
            loadMemos();
            alertMessage('å‚™å¿˜éŒ„å·²å„²å­˜ï¼', 'primary-bg');
        } else {
            saveData(LS_KEYS.MEMOS, []);
            loadMemos();
        }
    }

    function loadMemos() { /* ... */
        const memos = loadData(LS_KEYS.MEMOS, []);
        const container = document.getElementById('memo-list');
        const input = document.getElementById('memo-input');

        if (!container || !input) return;

        const currentText = memos[0] || '';
        input.value = currentText;

        container.innerHTML = '';
        if (currentText) {
            const linkRegex = /(https?:\/\/\S+|www\.\S+)/gi;
            const parts = currentText.split(linkRegex);

            const displayDiv = document.createElement('div');
            displayDiv.className = 'whitespace-pre-wrap text-gray-700 text-sm';

            parts.forEach(part => {
                if (part.match(linkRegex)) {
                    const url = part.startsWith('http') ? part : 'https://' + part;
                    const linkButton = document.createElement('a');
                    linkButton.href = url;
                    linkButton.target = '_blank';
                    linkButton.className = 'inline-flex items-center text-xs primary-text bg-primary/10 px-2 py-1 rounded-full font-medium hover:bg-primary/20 transition duration-150 mt-1 mr-2';
                    linkButton.innerHTML = `<i class="fa-solid fa-link mr-1"></i> é»æ“Šé€£çµ`;
                    displayDiv.appendChild(linkButton);
                } else {
                    displayDiv.appendChild(document.createTextNode(part));
                }
            });

            container.appendChild(displayDiv);
        } else {
            container.innerHTML = '<p class="text-center text-gray-500 p-2">ç›®å‰ç„¡å‚™å¿˜å…§å®¹ã€‚</p>';
        }
    }


    // ====================================================================
    // 8. INFO (è³‡è¨Š) æ¸²æŸ“å‡½æ•¸ (ç¶­æŒä¸è®Š)
    // ====================================================================

    function renderInfo(container) {
        const content = `
            <div class="space-y-6">
                <!-- å¤©æ°£èˆ‡ç·Šæ€¥é€£çµ -->
                <div class="bg-card p-5 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <h2 class="text-xl font-bold primary-text mb-3 flex items-center"><i class="fa-solid fa-cloud-sun-rain mr-2"></i> ç•¶åœ°å¤©æ°£èˆ‡å¯¦ç”¨é€£çµ</h2>
                    <p class="text-sm text-gray-600 mb-3">æŸ¥çœ‹æœ€æ–°çš„æ°£è±¡é å ±ï¼Œéš¨æ™‚æº–å‚™å¥½é›¨å…·ã€‚</p>
                    <a href="https://www.jma.go.jp/jma/index.html" target="_blank" class="w-full inline-flex items-center justify-center secondary-bg text-white p-3 rounded-lg font-bold shadow-md hover:opacity-90 transition duration-150">
                        <i class="fa-solid fa-temperature-low mr-2"></i> æ—¥æœ¬æ°£è±¡å»³ (JMA)
                    </a>
                </div>

                <!-- ç·Šæ€¥è¯çµ¡è³‡è¨Š -->
                <div class="bg-card p-5 rounded-xl shadow-lg border-l-4 border-red-500">
                    <h2 class="text-xl font-bold primary-text mb-3 flex items-center"><i class="fa-solid fa-bell mr-2"></i> ç·Šæ€¥è¯çµ¡è³‡è¨Š (æ—¥æœ¬ æ²–ç¹©)</h2>
                    <ul class="space-y-3">
                        <li class="flex justify-between items-center text-gray-700">
                            <span>è­¦å¯Ÿ (Police)</span>
                            <a href="tel:110" class="text-red-500 font-bold primary-bg/10 px-3 py-1 rounded-full hover:bg-red-500/20"><i class="fa-solid fa-phone mr-1"></i> 110</a>
                        </li>
                        <li class="flex justify-between items-center text-gray-700">
                            <span>æ•‘è­·è»Š/ç«è­¦ (Ambulance/Fire)</span>
                            <a href="tel:119" class="text-red-500 font-bold primary-bg/10 px-3 py-1 rounded-full hover:bg-red-500/20"><i class="fa-solid fa-phone mr-1"></i> 119</a>
                        </li>
                        <li class="flex justify-between items-center text-gray-700">
                            <span>é§é‚£éœ¸è¾¦äº‹è™• (å¤–äº¤éƒ¨)</span>
                            <a href="tel:+81988627008" class="text-blue-500 font-bold primary-bg/10 px-3 py-1 rounded-full hover:bg-blue-500/20"><i class="fa-solid fa-phone mr-1"></i> +81-98-862-7008</a>
                        </li>
                    </ul>
                </div>

                <!-- æ—…éŠç¦å¿Œèˆ‡æ³¨æ„äº‹é … -->
                <div class="bg-card p-5 rounded-xl shadow-lg border-l-4 border-amber-500">
                    <h2 class="text-xl font-bold primary-text mb-3 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i> æ—…éŠç¦å¿Œèˆ‡æ³¨æ„äº‹é …</h2>
                    <ul class="list-disc list-inside text-sm text-gray-600 ml-2 space-y-2">
                        <li><strong>å…¬å…±å ´æ‰€ï¼šï¼š</strong>è«‹å‹¿åœ¨è¡—é“ä¸Šé‚Šèµ°é‚Šåƒï¼Œæˆ–åœ¨ç¦è¸å€å¸è¸ã€‚</li>
                        <li><strong>æµ·é‚Šé˜²æ›¬ï¼šï¼š</strong>æ²–ç¹©ç´«å¤–ç·šå¼·ï¼Œå³ä¾¿ä¸æ˜¯å¤å­£ä¹Ÿéœ€åšå¥½é˜²æ›¬æªæ–½ã€‚</li>
                        <li><strong>å¤§çœ¾äº¤é€šï¼šï¼š</strong>é‚£éœ¸å¸‚å€äº¤é€šä»¥å–®è»Œé›»è»Šç‚ºä¸»ï¼Œå‰å¾€åŒ—éƒ¨å¦‚æ°´æ—é¤¨éœ€æ­ä¹˜é«˜é€Ÿå·´å£«ã€‚</li>
                        <li><strong>å‡ºå…¥å¢ƒï¼šï¼š</strong>åš´ç¦æ”œå¸¶æœªç¶“ç”³å ±æˆ–è¶…éé™é¡çš„è‚‰è£½å“ã€æ°´æœã€å‹•ç‰©è£½å“å…¥å¢ƒæ—¥æœ¬ã€‚</li>
                        <li><strong>å°è²»æ–‡åŒ–ï¼šï¼š</strong>æ—¥æœ¬æ²’æœ‰çµ¦å°è²»çš„ç¿’æ…£ã€‚</li>
                    </ul>
                </div>
            </div>
        `;
        container.innerHTML = content;
    }


    // ====================================================================
    // 9. é€šç”¨å·¥å…·èˆ‡å•Ÿå‹• (Utils & Startup)
    // ====================================================================
    
    // [æ–°å¢] é¡¯ç¤ºåœ°åœ– Modal
    function showMapModal(locationName, title) {
        const modal = document.getElementById('map-modal');
        const mapTitle = document.getElementById('map-modal-title');
        const externalLink = document.getElementById('map-external-link');
        const locationText = document.getElementById('map-location-text');

        // æ§‹å»º Google Maps App å°èˆªç¶²å€ (ç”¨æ–¼å¤–éƒ¨é€£çµ)
        // ä½¿ç”¨ https scheme ç¢ºä¿åœ¨ä»»ä½•ç€è¦½å™¨/App ä¸­éƒ½èƒ½é–‹å•Ÿ
        const appUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationName + ' æ²–ç¹©')}`;

        mapTitle.textContent = title;
        locationText.textContent = locationName;
        externalLink.href = appUrl;

        modal.classList.remove('hidden', 'opacity-0');
        modal.classList.add('opacity-100');
    }
    
    // [ä¿®æ­£] close modal for consistency
    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    }


    // é¡¯ç¤º Loading ç‹€æ…‹
    function showLoading(message = 'è¼‰å…¥ä¸­...') {
        document.getElementById('loading-message').textContent = message;
        document.getElementById('loading-modal').classList.remove('hidden');
    }

    // éš±è— Loading ç‹€æ…‹
    function hideLoading() {
        document.getElementById('loading-modal').classList.add('hidden');
    }

    // æµ®å‹•è¨Šæ¯é€šçŸ¥ (å–ä»£ alert/confirm)
    function alertMessage(message, bgColorClass = 'primary-bg') {
        const existingAlert = document.getElementById('floating-alert');
        if (existingAlert) existingAlert.remove();

        const alertDiv = document.createElement('div');
        alertDiv.id = 'floating-alert';
        alertDiv.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${bgColorClass} text-white px-4 py-2 rounded-full shadow-xl z-50 transition-opacity duration-300 opacity-0`;
        alertDiv.textContent = message;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.classList.remove('opacity-0');
            alertDiv.classList.add('opacity-100');
        }, 50);

        setTimeout(() => {
            alertDiv.classList.remove('opacity-100');
            alertDiv.classList.add('opacity-0');
            setTimeout(() => alertDiv.remove(), 300);
        }, 3000);
    }

    // å•Ÿå‹•å¾Œçš„åˆå§‹åŒ– (åœ¨ Firebase Auth å®Œæˆå¾ŒåŸ·è¡Œ)
    window.postAuthInit = function() {
        initializeStorage();

        // è¼‰å…¥ä¸Šæ¬¡åœç•™çš„ Tab
        const initialTab = localStorage.getItem(LS_KEYS.CURRENT_TAB) || 'plan';
        switchTab(initialTab);
    };


    // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å…¥å£
    window.onload = function() {
        // [ä¿®æ­£] ä¸å†ç­‰å¾… initFirebaseAndAuth å®Œæˆã€‚å…ˆæ¸²æŸ“ç•«é¢ã€‚
        window.postAuthInit(); 

        if (typeof window.initFirebaseAndAuth === 'function') {
            // åœ¨èƒŒæ™¯é–‹å§‹å˜—è©¦åˆå§‹åŒ– Firebase å’Œèªè­‰
            window.initFirebaseAndAuth(); 
        } else {
            console.error("Firebase Initialization function not found.");
            // å¦‚æœé€£æ¨¡çµ„éƒ½æ²’è¼‰å…¥ï¼Œä¹Ÿæ¨™è¨˜ Auth Ready é¿å… Plan é é¢å¡ä½ã€‚
            window.isAuthReady = true; 
        }
    };

</script>

<!-- åœ¨ HTML åº•éƒ¨åŠ å…¥ä¸€å€‹éš±è—çš„è¨Šæ¯å®¹å™¨ï¼Œç”¨æ–¼å–ä»£åŸç”Ÿçš„ alert/confirm -->
<div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center">
    <!-- è¨Šæ¯å…§å®¹æœƒå‹•æ…‹åŠ å…¥ -->
</div>

</body>
</html>